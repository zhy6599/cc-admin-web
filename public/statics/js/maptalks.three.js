!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,function(t,$,tt){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function i(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var M=parseInt(tt.REVISION.replace("dev",""));function et(t,e,n){return 109<M?t.setAttribute(e,n):t.addAttribute(e,n),t}function nt(){return!tt.VertexColors||tt.VertexColors}console.log("maptalks.three log: current three.js version is %c"+M,"color:red;font-size: 16px;font-weight: bold;");function n(){tt.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry",this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),et(this,"position",new tt.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),et(this,"uv",new tt.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}var a,o;n.prototype=Object.assign(Object.create(tt.InstancedBufferGeometry.prototype),{constructor:n,isLineSegmentsGeometry:!0,applyMatrix:function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new tt.InstancedInterleavedBuffer(e,6,1);return et(this,"instanceStart",new tt.InterleavedBufferAttribute(n,3,0)),et(this,"instanceEnd",new tt.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new tt.InstancedInterleavedBuffer(e,6,1);return et(this,"instanceColorStart",new tt.InterleavedBufferAttribute(n,3,0)),et(this,"instanceColorEnd",new tt.InterleavedBufferAttribute(n,3,3)),this},fromWireframeGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromEdgesGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromMesh:function(t){return this.fromWireframeGeometry(new tt.WireframeGeometry(t.geometry)),this},fromLineSegements:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},computeBoundingBox:(o=new tt.Box3,function(){null===this.boundingBox&&(this.boundingBox=new tt.Box3);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),o.setFromBufferAttribute(e),this.boundingBox.union(o))}),computeBoundingSphere:(a=new tt.Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new tt.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var r=0,i=0,o=t.count;i<o;i++)a.fromBufferAttribute(t,i),r=Math.max(r,n.distanceToSquared(a)),a.fromBufferAttribute(e,i),r=Math.max(r,n.distanceToSquared(a));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},copy:function(t){return this}});var e={},s={};e.line={linewidth:{value:1},resolution:{value:new tt.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},s.line={uniforms:tt.UniformsUtils.merge([tt.UniformsLib.common,tt.UniformsLib.fog,e.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};function v(t){tt.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:tt.UniformsUtils.clone(s.line.uniforms),vertexShader:s.line.vertexShader,fragmentShader:s.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}((v.prototype=Object.create(tt.ShaderMaterial.prototype)).constructor=v).prototype.isLineMaterial=!0,v.prototype.copy=function(t){return tt.ShaderMaterial.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.resolution=t.resolution,this};function c(t,e){tt.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==t?t:new n,this.material=void 0!==e?e:new v({color:16777215*Math.random()})}var h,l;c.prototype=Object.assign(Object.create(tt.Mesh.prototype),{constructor:c,isLineSegments2:!0,computeLineDistances:(h=new tt.Vector3,l=new tt.Vector3,function(){for(var t=this.geometry,e=t.attributes.instanceStart,n=t.attributes.instanceEnd,r=new Float32Array(2*e.data.count),i=0,o=0,a=e.data.count;i<a;i++,o+=2)h.fromBufferAttribute(e,i),l.fromBufferAttribute(n,i),r[o]=0===o?0:r[o-1],r[o+1]=r[o]+h.distanceTo(l);var s=new tt.InstancedInterleavedBuffer(r,2,1);return et(t,"instanceDistanceStart",new tt.InterleavedBufferAttribute(s,1,0)),et(t,"instanceDistanceEnd",new tt.InterleavedBufferAttribute(s,1,1)),this}),copy:function(t){return this}});function L(){n.call(this),this.type="LineGeometry"}L.prototype=Object.assign(Object.create(n.prototype),{constructor:L,isLineGeometry:!0,fromLine:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},copy:function(t){return this}});function g(t,e){c.call(this),this.type="Line2",this.geometry=void 0!==t?t:new L,this.material=void 0!==e?e:new v({color:16777215*Math.random()})}g.prototype=Object.assign(Object.create(c.prototype),{constructor:g,isLine2:!0,copy:function(t){return this}});function u(){}var f,p,d={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1},y=(i(x,f=$.Eventable(u)),x.prototype.addTo=function(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this},x.prototype.remove=function(){var t=this.getLayer();return t&&t.removeMesh([this]),this},x.prototype.getObject3d=function(){return this.object3d},x.prototype.getId=function(){return this.id},x.prototype.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},x.prototype.getType=function(){return this.type},x.prototype.getOptions=function(){return this.options},x.prototype.getProperties=function(){return(this.options||{}).properties},x.prototype.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},x.prototype.getLayer=function(){return this.options.layer},x.prototype.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},x.prototype.getCenter=function(){var t=this.getOptions(),e=t.coordinate,n=t.lineString,r=t.polygon;if(e)return e instanceof $.Coordinate?e:new $.Coordinate(e);var i=r||n;return i&&i.getCenter?i.getCenter():void 0},x.prototype.getAltitude=function(){return this.getOptions().altitude},x.prototype.setAltitude=function(t){if($.Util.isNumber(t)){var e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(var n=0,r=this._baseObjects.length;n<r;n++)this._baseObjects[n]&&(this._baseObjects[n].getObject3d().position.z=e)}return this},x.prototype.show=function(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this},x.prototype.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this},x.prototype.isVisible=function(){return!!this.getObject3d().visible},x.prototype.getSymbol=function(){return this.getObject3d().material},x.prototype.setSymbol=function(t){var e;return t&&t instanceof tt.Material&&(t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors,e=this.getObject3d().material.clone(),this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})),this},x.prototype.setInfoWindow=function(t){return this.removeInfoWindow(),this.infoWindow=new $.ui.InfoWindow(t),this.infoWindow.addTo(this),this},x.prototype.getInfoWindow=function(){return this.infoWindow},x.prototype.openInfoWindow=function(t){return(t=t||this.getCenter())instanceof $.Coordinate||(t=new $.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this},x.prototype.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},x.prototype.removeInfoWindow=function(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this},x.prototype.setToolTip=function(t,e){return this.removeToolTip(),this.toolTip=new $.ui.ToolTip(t,e),this.toolTip.addTo(this),this},x.prototype.getToolTip=function(){return this.toolTip},x.prototype.openToolTip=function(t){return(t=t||this.getCenter())instanceof $.Coordinate||(t=new $.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this},x.prototype.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},x.prototype.removeToolTip=function(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this},x.prototype.animateShow=function(t,n){var r=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),$.Util.isFunction(t)&&(n=t={});var e=t.duration||1e3,i=t.easing||"out",o=this._showPlayer=$.animation.Animation.animate({scale:1},{duration:e,easing:i},function(t){var e=t.styles.scale;0<e&&r.getObject3d().scale.set(1,1,e),n&&n(t,e)});return o.play(),o},x.prototype.getMinZoom=function(){return this.getOptions().minZoom},x.prototype.getMaxZoom=function(){return this.getOptions().maxZoom},x.prototype.isAsynchronous=function(){return this.getOptions().asynchronous},x.prototype.fire=function(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this},x.prototype.config=function(){return this},x.prototype.setPickObject3d=function(t){return this.pickObject3d=t,this.pickObject3d.__parent=this},x.prototype._initOptions=function(t){return this.options=$.Util.extend({},d,t),this},x.prototype._createMesh=function(t,e){return this.object3d=new tt.Mesh(t,e),this.object3d.__parent=this},x.prototype._createGroup=function(){return this.object3d=new tt.Group,this.object3d.__parent=this},x.prototype._createLine=function(t,e){return this.object3d=new tt.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},x.prototype._createLine2=function(t,e){return this.object3d=new g(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},x.prototype._createPoints=function(t,e){return this.object3d=new tt.Points(t,e),this.object3d.__parent=this},x.prototype._createLineSegments=function(t,e){return this.object3d=new tt.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},x);function x(t){var e=f.call(this)||this;return e.isAdd=!1,e._mouseover=!1,e._visible=!0,e._zoomVisible=!0,e.picked=!1,e.isBaseObject=!0,void 0===t&&(t=$.Util.GUID()),e.id=t,e}function F(t){var e=D(t),n=e.position,r=e.normal,i=e.uv,o=e.indices,a=new tt.BufferGeometry,s=new Float32Array(n.length);return s.fill(1,0,n.length),et(a,"color",new tt.BufferAttribute(s,3)),et(a,"normal",new tt.BufferAttribute(r,3)),et(a,"position",new tt.BufferAttribute(n,3)),i&&i.length&&et(a,"uv",new tt.BufferAttribute(i,2)),a.setIndex(new tt.BufferAttribute(o,1)),a}function D(t){for(var e={},n={},r=0;r<t.length;++r){var i=t[r];for(var o in i)void 0===e[o]&&(e[o]=[],n[o]=0),e[o].push(i[o]),n[o]+=i[o].length}var a={},s=0,c=[];for(var h in e)if("indices"===h)for(var l=e[h],r=0,u=l.length;r<u;r++){for(var f=l[r],p=0,d=f.length;p<d;p++)c.push(f[p]+s);s+=e.position[r].length/3}else{var v=function(t,e){for(var n=new Float32Array(e),r=0,i=0;i<t.length;++i)n.set(t[i],r),r+=t[i].length;return n}(e[h],n[h]);if(!v)return null;a[h]=v}return a.indices=new Uint32Array(c),a}function W(t){var e=t.position,n=t.normal,r=t.uv,i=t.indices,o=new Float32Array(e.length);o.fill(1,0,e.length);var a=new tt.BufferGeometry;return et(a,"color",new tt.BufferAttribute(o,3)),et(a,"normal",new tt.BufferAttribute(new Float32Array(n),3)),et(a,"position",new tt.BufferAttribute(new Float32Array(e),3)),et(a,"uv",new tt.BufferAttribute(new Float32Array(r),2)),a.setIndex(new tt.BufferAttribute(new Uint32Array(i),1)),a}function q(){return p||(p=new tt.BoxBufferGeometry(1e-6,1e-6,1e-6)),p}var m=Object.freeze({__proto__:null,mergeBufferGeometries:F,mergeBufferGeometriesAttribute:D,generateBufferGeometry:W,getDefaultBufferGeometry:q}),b={},H=new tt.BoxBufferGeometry(1,1,1);H.translate(0,0,.5);var _=new tt.Color("#fff"),w=new tt.Color("#fff");function N(t){var e,n,r=t.height,i=t.radialSegments,o=t.radius,a=(void 0===(e=i)&&(e=6),b[e]||((n=new tt.CylinderBufferGeometry(1,1,1,e,1)).rotateX(Math.PI/2),n.translate(0,0,.5),n.rotateZ(Math.PI/6),b[e]=n),b[e].clone());return a.scale(o,o,r),a}function K(t,e,n,r,i){void 0===r&&(r="y"),void 0===i&&(i=0);var o=0;"y"===r?o=1:"z"===r&&(o=2);var a=t.attributes.position.array,s=a.length;w.setStyle(e),_.setStyle(n);for(var c=[],h=0;h<s;h+=3){i<a[h+o]?c.push(_.r,_.g,_.b):c.push(w.r,w.g,w.b)}return et(t,"color",new tt.Float32BufferAttribute(c,3,!0)),c}function J(t){for(var e=[],n=[],r=0,i=t.length;r<i;r++){var o=t[r].attributes,a=o.color,s=o.normal,c=o.position,h=o.uv,l=t[r].index;if(a)for(var u=0,f=a.array.length;u<f;u++)n.push(a.array[u]);e.push({normal:s.array,uv:h.array,position:c.array,indices:l.array})}var p=F(e);n.length&&et(p,"color",new tt.Float32BufferAttribute(n,3,!0));for(r=0,i=t.length;r<i;r++)t[r].dispose();return p}var O,S={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"},Q=(i(j,O=y),j);function j(t,e,n,r){var i=this;e=$.Util.extend({},S,e,{layer:r,coordinate:t}),(i=O.call(this)||this)._initOptions(e);var o=e.height,a=e.radius,s=e.topColor,c=e.bottomColor,h=e.altitude;e.height=r.distanceToVector3(o,o).x,e.radius=r.distanceToVector3(a,a).x,e._radius=i.options.radius,e._height=i.options.height;var l=N(e);s&&(K(l,c,s,"z",e.height/2),n.vertexColors=nt()),i._createMesh(l,n);var u=r.distanceToVector3(h,h).x,f=r.coordinateToVector3(t,u);return i.getObject3d().position.copy(f),i.type="Bar",i}var A=T,C=T;function T(t,e,n){n=n||2;var r,i,o,a,s,c,h,l=e&&e.length,u=l?e[0]*n:t.length,f=B(t,0,u,n,!0),p=[];if(!f||f.next===f.prev)return p;if(l&&(f=function(t,e,n,r){var i,o,a,s,c,h=[];for(i=0,o=e.length;i<o;i++)a=e[i]*r,s=i<o-1?e[i+1]*r:t.length,(c=B(t,a,s,r,!1))===c.next&&(c.steiner=!0),h.push(function(t){var e=t,n=t;for(;(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next,e!==t;);return n}(c));for(h.sort(k),i=0;i<h.length;i++)!function(t,e){{var n;(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var c,h=n,l=n.x,u=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=l&&i!==r.x&&U(o<u?i:a,o,l,u,o<u?a:i,o,r.x,r.y)&&(c=Math.abs(o-r.y)/(i-r.x),X(r,t)&&(c<f||c===f&&(r.x>n.x||r.x===n.x&&function(t,e){return E(t.prev,t,e.prev)<0&&E(e.next,t,t.next)<0}(n,r)))&&(n=r,f=c)),r=r.next,r!==h;);return n}(t,e))&&(n=Y(e,t),z(e,e.next),z(n,n.next))}}(h[i],n),n=z(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var d=n;d<u;d+=n)(s=t[d])<r&&(r=s),(c=t[d+1])<i&&(i=c),o<s&&(o=s),a<c&&(a=c);h=0!==(h=Math.max(o-r,a-i))?1/h:0}return P(f,p,n,r,i,h),p}function B(t,e,n,r,i){var o,a;if(i===0<at(t,e,n,r))for(o=e;o<n;o+=r)a=rt(o,t[o],t[o+1],a);else for(o=n-r;e<=o;o-=r)a=rt(o,t[o],t[o+1],a);return a&&I(a,a.next)&&(it(a),a=a.next),a}function z(t,e){if(!t)return t;e=e||t;var n,r=t;do{if(n=!1,r.steiner||!I(r,r.next)&&0!==E(r.prev,r,r.next))r=r.next;else{if(it(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function P(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;for(;null===i.z&&(i.z=V(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==t;);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,c,h=1;do{for(n=t,o=t=null,a=0;n;){for(a++,r=n,e=s=0;e<h&&(s++,r=r.nextZ);e++);for(c=h;0<s||0<c&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,c--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,h*=2}while(1<a)}(i)}(t,r,i,o);for(var s,c,h=t;t.prev!==t.next;)if(s=t.prev,c=t.next,o?function(t,e,n,r){var i=t.prev,o=t,a=t.next;if(0<=E(i,o,a))return!1;var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,c=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,h=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,u=V(s,c,e,n,r),f=V(h,l,e,n,r),p=t.prevZ,d=t.nextZ;for(;p&&p.z>=u&&d&&d.z<=f;){if(p!==t.prev&&p!==t.next&&U(i.x,i.y,o.x,o.y,a.x,a.y,p.x,p.y)&&0<=E(p.prev,p,p.next))return!1;if(p=p.prevZ,d!==t.prev&&d!==t.next&&U(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=E(d.prev,d,d.next))return!1;d=d.nextZ}for(;p&&p.z>=u;){if(p!==t.prev&&p!==t.next&&U(i.x,i.y,o.x,o.y,a.x,a.y,p.x,p.y)&&0<=E(p.prev,p,p.next))return!1;p=p.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&U(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=E(d.prev,d,d.next))return!1;d=d.nextZ}return!0}(t,r,i,o):function(t){var e=t.prev,n=t,r=t.next;if(0<=E(e,n,r))return!1;var i=t.next.next;for(;i!==t.prev;){if(U(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=E(i.prev,i,i.next))return!1;i=i.next}return!0}(t))e.push(s.i/n),e.push(t.i/n),e.push(c.i/n),it(t),t=c.next,h=c.next;else if((t=c)===h){a?1===a?P(t=function(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!I(i,o)&&R(i,r,r.next,o)&&X(i,o)&&X(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),it(r),it(r.next),r=t=o),r=r.next}while(r!==t);return z(r)}(z(t),e,n),e,n,r,i,o,2):2===a&&function(t,e,n,r,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&function(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&R(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(X(t,e)&&X(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==t;);return r}(t,e)&&(E(t.prev,t,e.prev)||E(t,e.prev,e))||I(t,e)&&0<E(t.prev,t,t.next)&&0<E(e.prev,e,e.next))}(a,s)){var c=Y(a,s);return a=z(a,a.next),c=z(c,c.next),P(a,e,n,r,i,o),P(c,e,n,r,i,o)}s=s.next}a=a.next}while(a!==t)}(t,e,n,r,i,o):P(z(t),e,n,r,i,o,1);break}}}function k(t,e){return t.x-e.x}function V(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function U(t,e,n,r,i,o,a,s){return 0<=(i-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(r-s)-(n-a)*(e-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function E(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function I(t,e){return t.x===e.x&&t.y===e.y}function R(t,e,n,r){var i=G(E(t,e,n)),o=G(E(t,e,r)),a=G(E(n,r,t)),s=G(E(n,r,e));return i!==o&&a!==s||(0===i&&Z(t,n,e)||(0===o&&Z(t,r,e)||(0===a&&Z(n,t,r)||!(0!==s||!Z(n,e,r)))))}function Z(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function G(t){return 0<t?1:t<0?-1:0}function X(t,e){return E(t.prev,t,t.next)<0?0<=E(t,e,t.next)&&0<=E(t,t.prev,e):E(t,e,t.prev)<0||E(t,t.next,e)<0}function Y(t,e){var n=new ot(t.i,t.x,t.y),r=new ot(e.i,e.x,e.y),i=t.next,o=e.prev;return(t.next=e).prev=t,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function rt(t,e,n,r){var i=new ot(t,e,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function it(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ot(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function at(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function st(t,e){var n=t.length-1,r=[t[0]];return function t(e,n,r,i,o){for(var a,s,c,h,l,u,f,p,d,v=i,g=n+1;g<r;g++){var y=(s=e[g],c=e[n],h=e[r],d=p=f=u=l=void 0,u=c[0],f=c[1],p=h[0]-u,d=h[1]-f,0===p&&0===d||(1<(l=((s[0]-u)*p+(s[1]-f)*d)/(p*p+d*d))?(u=h[0],f=h[1]):0<l&&(u+=p*l,f+=d*l)),(p=s[0]-u)*p+(d=s[1]-f)*d);v<y&&(a=g,v=y)}i<v&&(1<a-n&&t(e,n,a,i,o),o.push(e[a]),1<r-a&&t(e,a,r,i,o))}(t,0,n,e,r),r.push(t[n]),r}function ct(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=st(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],c=[s],h=1,l=t.length;h<l;h++)n=t[h],i=s,a=o=void 0,o=(r=n)[0]-i[0],a=r[1]-i[1],e<o*o+a*a&&(c.push(n),s=n);return s!==n&&c.push(n),c}(t,r),r)}function ht(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function lt(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function ut(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}T.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(at(t,0,o,n));if(i)for(var s=0,c=e.length;s<c;s++){var h=e[s]*n,l=s<c-1?e[s+1]*n:t.length;a-=Math.abs(at(t,h,l,n))}for(var u=0,s=0;s<r.length;s+=3){var f=r[s]*n,p=r[s+1]*n,d=r[s+2]*n;u+=Math.abs((t[f]-t[d])*(t[1+p]-t[1+f])-(t[f]-t[p])*(t[1+d]-t[1+f]))}return 0===a&&0===u?0:Math.abs((u-a)/a)},T.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);0<i&&(r+=t[i-1].length,n.holes.push(r))}return n},A.default=C;var ft=[];function pt(t,e,n,r){var i,o,a,s,c,h,l,u,f,p,d,v=(o=n,(i=e)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),g=Math.acos(v)*r;return lt(ft,n,e,-v),c=(s=a=ft)[0],h=s[1],l=s[2],u=Math.sqrt(c*c+h*h+l*l),a[0]=c/u,a[1]=h/u,a[2]=l/u,f=t,p=e,d=Math.cos(g),f[0]=p[0]*d,f[1]=p[1]*d,f[2]=p[2]*d,lt(t,t,ft,Math.sin(g)),t}function dt(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],c=t[o],h=t[o+1],i=o;o+=2,r+=a*h-c*s}return r}function vt(t,e,n){return void 0===n&&(n=2),A(t,e,n)}var gt=[],yt=[],xt=[];function mt(t,e,n,r,i,o,a,s){var c=null!=a,h=i,l=null;c&&(l=new Uint32Array(r-n));for(var u,f,p,d,v,g=n;g<r;g++){var y,x,m,b,_,w,M,O,S=g===r-1?n:g+1,j=g===n?r-1:g-1,A=t[2*j],C=t[2*j+1],T=t[2*g],L=t[2*g+1],B=t[2*S],z=t[2*S+1];gt[0]=T-A,gt[1]=L-C,yt[0]=B-T,yt[1]=z-L,ht(gt,gt),ht(yt,yt),c&&(l[g]=h),s||g!==n?s||g!==r-1?(d=yt,v=gt,(p=xt)[0]=d[0]+v[0],p[1]=d[1]+v[1],y=xt[1],xt[1]=-xt[0],xt[0]=y,ht(xt,xt),f=yt,x=(u=xt)[0]*f[0]+u[1]*f[1],m=Math.sqrt(1-x*x),b=o*Math.min(10,1/m),c&&a<1/m&&o*x<0?(_=T+xt[0]*o,w=L+xt[1]*o,M=Math.acos(m)/2,O=Math.tan(M)*Math.abs(o),e[2*h]=_+xt[1]*O,e[2*h+1]=w-xt[0]*O,e[2*++h]=_-xt[1]*O,e[2*h+1]=w+xt[0]*O):(e[2*h]=T+xt[0]*b,e[2*h+1]=L+xt[1]*b)):(xt[0]=gt[1],xt[1]=-gt[0],ht(xt,xt),e[2*h]=T+xt[0]*o,e[2*h+1]=L+xt[1]*o):(xt[0]=yt[1],xt[1]=-yt[0],ht(xt,xt),e[2*h]=T+xt[0]*o,e[2*h+1]=L+xt[1]*o),h++}return l}function bt(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(mt(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];mt(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function _t(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,c=t[a];t[a]=t[s],t[s]=c}return t}function wt(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(0<t.bevelSegments?t.bevelSize:0,t.depth/2)),0<t.bevelSize||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e,n,r,i,o=t.boundingRect;t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect&&(e=null==t.fitRect.x?o.x||0:t.fitRect.x,n=null==t.fitRect.y?o.y||0:t.fitRect.y,r=t.fitRect.width,i=t.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),t.scale=[r/o.width,i/o.height],t.translate=[(e-o.x)*t.scale[0],(n-o.y)*t.scale[1]])}function Mt(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r,i,o,a,s,c,h,l,u,f=[],p=[],d=[],v=[],g=[],y=[],x=t.length,m=new Float32Array(e.length),b=0;b<x;){var _=3*t[b++],w=3*t[b++],M=3*t[b++];n(f,e[_],e[1+_],e[2+_]),n(p,e[w],e[1+w],e[2+w]),n(d,e[M],e[1+M],e[2+M]),ut(v,f,p),ut(g,p,d),r=y,o=g,u=l=h=c=s=a=void 0,a=(i=v)[0],s=i[1],c=i[2],h=o[0],l=o[1],u=o[2],r[0]=s*u-c*l,r[1]=c*h-a*u,r[2]=a*l-s*h;for(var O=0;O<3;O++)m[_+O]=m[_+O]+y[O],m[w+O]=m[w+O]+y[O],m[M+O]=m[M+O]+y[O]}for(var S,j,A,C,T,L,B=0;B<m.length;)n(y,m[B],m[B+1],m[B+2]),L=T=C=A=void 0,A=(j=S=y)[0],C=j[1],T=j[2],L=Math.sqrt(A*A+C*C+T*T),S[0]=A/L,S[1]=C/L,S[2]=T/L,m[B++]=y[0],m[B++]=y[1],m[B++]=y[2];return m}var Ot=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function St(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,c=e.depth,h=e.rect,l=r-n,u=o.smoothSide?1:2,f=l*u,p=o.smoothBevel?1:2,d=Math.min(c/2,o.bevelSize),v=o.bevelSegments,g=i.vertex,y=Math.max(h.width,h.height,c);if(0<d)for(var x=[0,0,1],m=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(l),O=0;O<2;O++)for(var S=0===O?c-d:d,j=0;j<=v*p;j++){for(var A=0,C=void 0,T=void 0,L=0;L<l;L++){for(var B=0;B<u;B++){var z=2*((L+B)%l+n);m[0]=a[z]-s[z],m[1]=a[1+z]-s[1+z],m[2]=0;var P=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=P,m[1]/=P;var k=(Math.floor(j/p)+j%p)/v;0===O?pt(_,x,m,k):pt(_,m,b,k);var V,U,E,I,R=0===O?k:1-k,Z=d*Math.sin(R*Math.PI/2),G=P*Math.cos(R*Math.PI/2),F=d*P/Math.sqrt(Z*Z+G*G),D=_[0]*F+s[z],W=_[1]*F+s[1+z],q=_[2]*F+S;t.position[3*i.vertex]=D,t.position[3*i.vertex+1]=W,t.position[3*i.vertex+2]=q,(0<L||0<B)&&(A+=Math.sqrt((C-D)*(C-D)+(T-W)*(T-W))),(0<j||0<O)&&(V=3*(i.vertex-f),U=t.position[V],E=t.position[1+V],I=t.position[2+V],M[L]+=Math.sqrt((U-D)*(U-D)+(E-W)*(E-W)+(I-q)*(I-q))),t.uv[2*i.vertex]=A/y,t.uv[2*i.vertex+1]=M[L]/y,C=D,T=W,i.vertex++}if(1<p&&j%p||1==p&&1<=j)for(var H=0;H<6;H++){var N=(Ot[H][0]+L*u)%f,K=Ot[H][1]+w;t.indices[i.index++]=(K-1)*f+N+g}}w++}else for(var J=0;J<2;J++)for(var Q=0===J?c-d:d,X=0,Y=void 0,$=void 0,tt=0;tt<l;tt++)for(var et=0;et<u;et++){var nt=2*((tt+et)%l+n),rt=a[nt],it=a[1+nt];t.position[3*i.vertex]=rt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=Q,(0<tt||0<et)&&(X+=Math.sqrt((Y-rt)*(Y-rt)+($-it)*($-it))),t.uv[2*i.vertex]=X/y,t.uv[2*i.vertex+1]=Q/y,Y=rt,$=it,i.vertex++}for(var ot=0<d?v*p+1:1,at=0;at<l;at++)for(var st=0;st<6;st++){var ct=(Ot[st][0]+at*u)%f,ht=Ot[st][1]+ot;t.indices[i.index++]=(ht-1)*f+ct+g}}function jt(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.vertices,c=o.holes,h=o.depth,l=s.length/2,u=0<Math.min(h/2,e.bevelSize)?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=l*(e.excludeBottom?1:2);for(var f=2+2*u,p=0,d=0,v=0;v<(c?c.length:0)+1;v++){n+=6*((d=0===v?c&&c.length?c[0]:l:(p=c[v-1],c[v]||l))-p)*(f-1);var g=(d-p)*(e.smoothSide?1:2);r+=g*f+(e.smoothBevel?0:u*g*2)}}for(var y={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},x={vertex:0,index:0},m=0;m<t.length;m++)!function(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,c=t.depth;if(!(o.length<=4)){for(var h=n.vertex,l=i.length,u=0;u<l;u++)e.indices[n.index++]=h+i[u];for(var f=Math.max(s.width,s.height),p=0;p<(r.excludeBottom?1:2);p++)for(var d=0;d<a.length;d+=2){var v=a[d],g=a[d+1];e.position[3*n.vertex]=v,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-p)*c,e.uv[2*n.vertex]=(v-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var y=o.length/2,x=0;x<l;x+=3)for(var m=0;m<3;m++)e.indices[n.index++]=h+y+i[x+2-m]}}(t[m],y,x,e);for(var b=0;b<t.length;b++){var _,w=t[b],M=w.holes,O=w.vertices.length/2,S=M&&M.length?M[0]:O;if(St(y,t[b],0,S,x,e),M)for(var j=0;j<M.length;j++)_=M[j],S=M[j+1]||O,St(y,t[b],_,S,x,e)}for(var A=0;A<y.uv.length;A++){var C=y.uv[A];0<C&&Math.round(C)===C?y.uv[A]=1:y.uv[A]=C%1}return y.normal=Mt(y.indices,y.position),y.boundingRect=t[0]&&t[0].rect,y}function At(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)Tt(t[i][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},wt(e);for(var o=[],a=e.translate||[0,0],s=e.scale||[1,1],c=e.boundingRect,h={x:c.x*s[0]+a[0],y:c.y*s[1]+a[1],width:c.width*s[0],height:c.height*s[1]},l=Math.min(c.width,c.height)/1e5,u=0;u<t.length;u++){var f=function(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],c=i[a-1][1],h=0,l=0;l<a;l++){var u=i[l][0],f=i[l][1],p=u-s,d=f-c;e<(h+=Math.sqrt(p*p+d*d))&&(o.push(i[l]),h=0),s=u,c=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(t[u],l);if(f){var p=e.simplify/Math.max(s[0],s[1]);if(0<p&&(f=function(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];3<=(i=ct(i,e,!0)).length&&n.push(i)}return 0<n.length?n:null}(f,p)),f){for(var d=A.flatten(f),v=d.vertices,g=d.holes,y=d.dimensions,x=0;x<v.length;)v[x]=v[x++]*s[0]+a[0],v[x]=v[x++]*s[1]+a[1];if(!function(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;0<dt(t,r,i)&&_t(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)dt(t,r=e[o-1],i=e[o]||n)<0&&_t(t,2,r,i)}(v,g),2!==y)throw new Error("Only 2D polygon points are supported");var m=0<e.bevelSize?bt(v,g,e.bevelSize,null,!0):v,b=vt(m,g,y);o.push({indices:b,vertices:v,topVertices:m,holes:g,rect:h,depth:"function"==typeof e.depth?e.depth(u):e.depth})}}}return jt(o,e)}function Ct(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)Tt(t[i],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},wt(e);var o=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);for(var a=[],s=0;s<t.length;s++){var c=t[s],h=e.simplify/Math.max(o[0],o[1]);0<h&&(c=ct(c,h,!0)),a.push(function(t,e,n){for(var r=n.lineWidth,i=t.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1],c=0,h=0;c<i;c++)o[h++]=t[c][0]*s[0]+a[0],o[h++]=t[c][1]*s[1]+a[1];dt(o,0,i)<0&&_t(o,2,0,i);var l=[],u=[],f=n.miterLimit,p=mt(o,u,0,i,0,-r/2,f,!1);_t(o,2,0,i);for(var d=mt(o,l,0,i,0,-r/2,f,!1),v=(l.length+u.length)/2,g=new Float32Array(2*v),y=0,x=u.length/2,m=0;m<u.length;m++)g[y++]=u[m];for(var b=0;b<l.length;b++)g[y++]=l[b];for(var _=new(65535<v?Uint32Array:Uint16Array)(3*(2*(i-1)+(v-2*i))),w=0,M=0;M<i-1;M++){var O=M+1;_[w++]=x-1-p[M],_[w++]=x-1-p[M]-1,_[w++]=d[M]+1+x,_[w++]=x-1-p[M],_[w++]=d[M]+1+x,_[w++]=d[M]+x,d[O]-d[M]==2?(_[w++]=d[M]+2+x,_[w++]=d[M]+1+x,_[w++]=x-p[O]-1):p[O]-p[M]==2&&(_[w++]=d[O]+x,_[w++]=x-1-(p[M]+1),_[w++]=x-1-(p[M]+2))}var S=0<n.bevelSize?bt(g,[],n.bevelSize,null,!0):g,j=n.boundingRect;return{vertices:g,indices:_,topVertices:S,rect:{x:j.x*s[0]+a[0],y:j.y*s[1]+a[1],width:j.width*s[0],height:j.height*s[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}(c,s,e))}return jt(a,e)}function Tt(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}var Lt=Object.freeze({__proto__:null,triangulate:vt,flatten:function(t){return A.flatten(t)},offsetPolygon:bt,extrudePolygon:At,extrudePolyline:Ct,extrudeGeoJSON:function(e,t){t=Object.assign({},t);for(var n=[],r=[],i=[],o=[],a=[1/0,1/0],s=[-1/0,-1/0],c=0;c<e.features.length;c++){var h=e.features[c].geometry;if(h&&h.coordinates)switch(h.type){case"LineString":n.push(h.coordinates),i.push(c),Tt(h.coordinates,a,s);break;case"MultiLineString":for(var l=0;l<h.coordinates.length;l++)n.push(h.coordinates[l]),i.push(c),Tt(h.coordinates[l],a,s);break;case"Polygon":r.push(h.coordinates),o.push(c),Tt(h.coordinates[0],a,s);break;case"MultiPolygon":for(var u=0;u<h.coordinates.length;u++)r.push(h.coordinates[u]),o.push(c),Tt(h.coordinates[u][0],a,s)}}t.boundingRect=t.boundingRect||{x:a[0],y:a[1],width:s[0]-a[0],height:s[1]-a[1]};var f=t.depth;return{polyline:Ct(n,Object.assign(t,{depth:function(t){return"function"==typeof f?f(e.features[i[t]]):f}})),polygon:At(r,Object.assign(t,{depth:function(t){return"function"==typeof f?f(e.features[o[t]]):f}}))}}}),Bt=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function zt(t){return t.geometry?t.geometry.type:null}function Pt(t){var e=zt(t);if(e)for(var n=0,r=Bt.length;n<r;n++)if(Bt[n]===e)return!0;return!1}function kt(t){var e=zt(t);return!(!e||e!==Bt[4]&&e!==Bt[5])}function Vt(t){var e=zt(t);return!(!e||e!==Bt[2]&&e!==Bt[3])}function Ut(t){var e=zt(t);return!(!e||e!==Bt[0]&&e!==Bt[1])}function Et(t){var e=zt(t);return!!(e&&-1<e.indexOf("Multi"))}function It(t){return t.geometry?t.geometry.coordinates:[]}function Rt(t){var e=zt(t);if(!e||!t.geometry)return null;var n=t.geometry.coordinates;if(!n)return null;var r=[];switch(e){case"Point":r.push(n);break;case"MultiPoint":case"LineString":for(var i=0,o=n.length;i<o;i++)r.push(n[i]);break;case"MultiLineString":case"Polygon":for(i=0,o=n.length;i<o;i++)for(var a=0,s=n[i].length;a<s;a++)r.push(n[i][a]);break;case"MultiPolygon":for(i=0,o=n.length;i<o;i++)for(a=0,s=n[i].length;a<s;a++)for(var c=0,h=n[i][a].length;c<h;c++)r.push(n[i][a][c])}for(var l=1/0,u=1/0,f=-1/0,p=-1/0,i=0,o=r.length;i<o;i++)var d=r[i],v=d[0],g=d[1],l=Math.min(l,v),u=Math.min(u,g),f=Math.max(f,v),p=Math.max(p,g);return new $.Coordinate((l+f)/2,(u+p)/2)}function Zt(t){var e=zt(t);if(!e||!t.geometry)return null;var n=t.geometry,r=t.properties||{},i=n.coordinates;if(!i)return null;var o,a=[];switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(var s=0,c=i.length;s<c;s++)a.push({type:"Feature",geometry:{type:o,coordinates:i[s]},properties:r});else a.push(t);return a}var Gt=Object.freeze({__proto__:null,isGeoJSON:Pt,isGeoJSONPolygon:kt,isGeoJSONLine:Vt,isGeoJSONPoint:Ut,isGeoJSONMulti:Et,getGeoJSONCoordinates:It,getGeoJSONCenter:Rt,spliteGeoJSONMulti:Zt}),Ft=",";function Dt(t,e,n){var r=[],i=[];if(Array.isArray(t)&&t[0]instanceof tt.Vector3)for(var o=0,a=t.length;o<a;o++){var s=t[o];r.push(s.x,s.y,s.z),i.push(s)}else{Array.isArray(t)&&(t=new $.LineString(t));var c=void 0,h=void 0;Pt(t)?(c=It(t),h=Rt(t)):t instanceof $.LineString&&(c=t.getCoordinates(),h=t.getCenter());for(var l=e.coordinateToVector3(n||h),o=0,a=c.length;o<a;o++){var u=c[o];Array.isArray(u)&&(u=new $.Coordinate(u));s=e.coordinateToVector3(u,0).sub(l);r.push(s.x,s.y,s.z),i.push(s)}}return{positions:r,positionsV:i}}function Wt(t,e,n,r){for(var i=[],o=[],a=[],s=0,c=t.length;s<c;s++)for(var h=t[s],l=0,u=h.length;l<u;l++){var f=h[l];0<a.length&&(d=f.join(Ft).toString())===a[a.length-1].join(Ft).toString()||a.push(f)}for(s=0,c=a.length;s<c;s++){var p=void 0,d=(f=a[s]).join(Ft).toString(),p=n&&n[d]?n[d]:e.coordinateToVector3(f,0).sub(r);o.push(p),i.push(p.x,p.y,p.z)}return{positions:i,positionsV:o,lnglats:a}}function qt(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=Dt(t,r,i).positionsV,a=[],s=0,c=o.length;s<c;s++){var h=o[s];a.push([h.x,h.y])}var l=Ct([a],{lineWidth:e,depth:n}),u=l.indices;return{position:l.position,normal:l.normal,indices:u,uv:l.uv}}function Ht(t){var e,n=[];return t instanceof $.MultiLineString?(n=t.getGeometries(),e=t.getCenter()):t instanceof $.LineString?(n.push(t),e=t.getCenter()):Pt(t)&&(e=Rt(t),Et(t)?n=Zt(t):n.push(t)),{lineStrings:n,center:e}}var Nt=Object.freeze({__proto__:null,getLinePosition:Dt,getExtrudeLineGeometry:function(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=Dt(t,r,i).positionsV,a=[],s=0,c=o.length;s<c;s++){var h=o[s];a.push([h.x,h.y])}var l=Ct([a],{lineWidth:e,depth:n}),u=l.indices,f=l.position,p=l.normal,d=l.uv,v=new tt.BufferGeometry;return et(v,"position",new tt.Float32BufferAttribute(f,3)),et(v,"normal",new tt.Float32BufferAttribute(p,3)),et(v,"uv",new tt.Float32BufferAttribute(d,2)),v.setIndex(new tt.Uint32BufferAttribute(u,1)),v},getChunkLinesPosition:Wt,getExtrudeLineParams:qt,LineStringSplit:Ht});var Kt,Jt={altitude:0,colors:null},Qt=(i(Xt,Kt=y),Xt);function Xt(t,e,n,r){var i=this;e=$.Util.extend({},Jt,e,{layer:r,lineString:t}),(i=Kt.call(this)||this)._initOptions(e);for(var o=Ht(t),a=o.lineStrings,s=o.center,c=[],h=0,l=a.length;h<l;h++)for(var u=Dt(a[h],r,s).positionsV,f=0,p=u.length;f<p;f++){var d=u[f];0<f&&f<p-1&&c.push(d.x,d.y,d.z),c.push(d.x,d.y,d.z)}var v=new tt.BufferGeometry;et(v,"position",new tt.Float32BufferAttribute(c,3));var g,y,x=(g=e.colors,y=[],g&&g.length&&g.forEach(function(t){t=t instanceof tt.Color?t:new tt.Color(t),y.push(t.r,t.g,t.b)}),y);x&&x.length&&(et(v,"color",new tt.Float32BufferAttribute(x,3)),n.vertexColors=nt()),i._createLineSegments(v,n);var m=e.altitude,b=r.distanceToVector3(m,m).x,_=r.coordinateToVector3(s,b);return i.getObject3d().position.copy(_),i.type="Line",i}var Yt=new tt.Color("#fff"),$t=new tt.Color("#fff");function te(t,e,n,r){var i=ee(t,e,n,r),o=i.position,a=i.normal,s=i.uv,c=i.indices,h=new Float32Array(o.length);h.fill(1,0,o.length);var l=new tt.BufferGeometry;return et(l,"color",new tt.BufferAttribute(h,3)),et(l,"normal",new tt.BufferAttribute(a,3)),et(l,"position",new tt.BufferAttribute(o,3)),et(l,"uv",new tt.BufferAttribute(s,2)),l.setIndex(new tt.Uint32BufferAttribute(c,1)),l}function ee(t,e,n,r,i){var o=re(t,n,r);if(!o)return null;var a=At(o,{depth:e=i?(null==i[e]&&(i[e]=n.distanceToVector3(e,e).x),i[e]):n.distanceToVector3(e,e).x});return{position:a.position,normal:a.normal,uv:a.uv,indices:a.indices}}function ne(t,e,n){var r=t.attributes.position.array,i=r.length;$t.setStyle(e),Yt.setStyle(n);for(var o=[],a=0;a<i;a+=3){0<r[a+2]?o.push(Yt.r,Yt.g,Yt.b):o.push($t.r,$t.g,$t.b)}return et(t,"color",new tt.Float32BufferAttribute(o,3,!0)),o}function re(e,n,r,i){if(void 0===i&&(i=!1),!e)return null;var t=[];if(e instanceof $.MultiPolygon)t=e.getGeometries().map(function(t){return ie(t,n,r||e.getCenter(),i)});else if(e instanceof $.Polygon){var o=ie(e,n,r||e.getCenter(),i);t.push(o)}else if(kt(e)){var a=Rt(e);if(Et(e))for(var s=Zt(e),c=0,h=s.length;c<h;c++)t.push(ie(s[c],n,r||a,i));else{o=ie(e,n,r||a,i);t.push(o)}}return t}function ie(t,e,n,r){var i,o,a;void 0===r&&(r=!1),kt(t)?(o=(i=It(t))[0],a=i.slice(1,i.length),n=n||Rt(t)):t instanceof $.Polygon&&(o=t.getShell(),a=t.getHoles(),n=n||t.getCenter());for(var s=e.coordinateToVector3(n),c=r?new Float32Array(2*o.length):[],h=0,l=o.length;h<l;h++){var u=o[h],f=e.coordinateToVector3(u).sub(s);r?(c[y=2*h]=f.x,c[y+1]=f.y):c.push([f.x,f.y])}var p=[r?c.buffer:c];if(a&&0<a.length)for(h=0,l=a.length;h<l;h++){for(var d=r?new Float32Array(2*a[h].length):[],v=0,g=a[h].length;v<g;v++){var y,u=a[h][v],x=e.coordinateToVector3(u).sub(s);r?(d[y=2*v]=x.x,d[y+1]=x.y):d.push([x.x,x.y])}p.push(r?d.buffer:d)}return p}var oe,ae=Object.freeze({__proto__:null,getExtrudeGeometry:te,getExtrudeGeometryParams:ee,initVertexColors:ne,getPolygonPositions:re,getSinglePolygonPositions:ie}),se={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"},ce=(i(he,oe=y),he);function he(t,e,n,r){var i=this;e=$.Util.extend({},se,e,{layer:r,lineString:t}),(i=oe.call(this)||this)._initOptions(e);var o=e.height,a=e.width,s=e.bottomColor,c=e.topColor;e.height=r.distanceToVector3(o,o).x,e.width=r.distanceToVector3(a,a).x;for(var h=Ht(t),l=h.lineStrings,u=h.center,f=[],p=0,d=l.length;p<d;p++)f.push(qt(l[p],e.width,e.height,r,u));var v=F(f);c&&(ne(v,s,c),n.vertexColors=nt()),i._createMesh(v,n);var g=e.altitude,y=r.distanceToVector3(g,g).x,x=r.coordinateToVector3(u,y);return i.getObject3d().position.copy(x),i.type="ExtrudeLine",i}var le,ue={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},fe=(i(pe,le=y),pe);function pe(t,e,n,r){var i=this;e=$.Util.extend({},ue,e,{layer:r,polygon:t}),(i=le.call(this)||this)._initOptions(e);var o=e.height,a=e.topColor,s=e.bottomColor,c=e.altitude,h=te(t,o,r),l=kt(t)?Rt(t):t.getCenter();a&&(ne(h,s,a),n.vertexColors=nt()),i._createMesh(h,n);var u=r.distanceToVector3(c,c).x,f=r.coordinateToVector3(l,u);return i.getObject3d().position.copy(f),i.type="ExtrudePolygon",i}var de,ve={altitude:0,coordinate:null},ge=(i(ye,de=y),ye);function ye(t,e,n){void 0===e&&(e={});var r=this;e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=$.Util.extend({},ve,e,{layer:n,model:t}),(r=de.call(this)||this)._initOptions(e),r._createGroup(),r.getObject3d().add(t);var i=e.altitude,o=e.coordinate,a=n.distanceToVector3(i,i).x,s=n.coordinateToVector3(o,a);return r.getObject3d().position.copy(s),r.type="Model",r}var xe=Math.PI/180,me=6378137,be=1;function _e(t){return t.getCoordinates().map(function(t){return t.toArray()})}function we(t){return t*xe}function Me(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var n=we(t[1]),r=we(e[1]),i=n-r,o=we(t[0])-we(e[0]),n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2)));return n*=me,Math.round(1e5*n)/1e5}function Oe(t,e){void 0===e&&(e=10),e=Math.max(e,be),Array.isArray(t)||(t=_e(t));for(var n=t.length,r=[],i=0,o=0;o<n-1;o++){var a=Me(t[o],t[o+1]),s=Math.floor(a);r.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return r.map(function(t){return[t.c1,t.c2]});if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];for(var c,h,l,u,f,p,d,v,g,y=r.length,x=0,m=0,b=[],_=[r[0].c1];x<y;){var w,M=r[x],a=M.len,O=M.c2;(m+=a)<e&&(_.push(O),x===y-1&&b.push(_),x++),m===e&&(_.push(O),m=0,b.push(_),_=[O],x++),e<m&&(w=a-m+e,h=r[x],l=w,g=v=d=p=f=u=void 0,u=h.len,f=h.c1,p=h.c2,d=p[0]-f[0],v=p[1]-f[1],g=l/u,c=[f[0]+g*d,f[1]+g*v],_.push(c),b.push(_),m=0,r[x].c1=c,r[x].len=a-w,(_=[]).push(c))}return b}var Se=Object.freeze({__proto__:null,distance:Me,lineLength:function(t){var e=t;Array.isArray(t)||(e=_e(t));for(var n=0,r=0,i=e.length;r<i-1;r++)n+=Me(e[r],e[r+1]);return n},lineSlice:Oe});function je(t,e,n,r){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=n[s];t.index.count=r.length;for(var s=0,c=r.length;s<c;s++)t.index.array[s]=r[s]}var Ae,Ce={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},Te=(i(Le,Ae=y),Le.prototype._init=function(t){for(var e=t.layer,n=t.trail,r=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,c=o.length,h=[],l=0;l<c;l++){var u=Wt(o.slice(l,l+n),e,a,s).positionsV;h.push(qt(u,r,i,e))}this._params.geometries=h,this._params.loaded=!0},Le.prototype._animation=function(){var t,e,n,r=this._params,i=r.index,o=r.geometries,a=r.speed,s=r.idx,c=r.chunkLines,h=r.trail,l=r.lineWidth,u=r.depth,f=r.loaded,p=r.layer,d=r.positionMap,v=r.centerPt;f&&(s<(t=Math.round(i))&&(this._params.idx++,(e=o[t])||(e=qt(Wt(c.slice(t,t+h),p,d,v).positionsV,l,u,p),o[t]=e),je((n=this.getObject3d()).geometry,e.position,e.normal,e.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0),i>=c.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=a)},Le);function Le(t,e,n,r){var i=this;e=$.Util.extend({},Ce,e,{layer:r,lineString:t}),(i=Ae.call(this)||this)._initOptions(e);for(var o,a=e.width,s=e.height,c=e.altitude,h=e.speed,l=e.chunkLength,u=e.trail,f=Pt(t)?(o=Rt(t),It(t)):(o=t.getCenter(),t),p=Oe(f,l),d=r.coordinateToVector3(o),v={},g=0,y=p.length;g<y;g++)for(var x=p[g],m=0,b=x.length;m<b;m++){var _=x[m],w=_.join(",").toString();v[w]||(v[w]=r.coordinateToVector3(_).sub(d))}var M=Wt(p.slice(0,1),r,v,d).positionsV,O=new tt.BufferGeometry,S=new Float32Array(3e3),j=new Float32Array(3e3),A=new Uint16Array(1e3);et(O,"position",new tt.BufferAttribute(S,3)),et(O,"normal",new tt.BufferAttribute(j,3)),O.setIndex(new tt.BufferAttribute(A,1));var C=r.distanceToVector3(a,a).x,T=r.distanceToVector3(s,s).x,L=qt(M,C,T,r);je(O,L.position,L.normal,L.indices),i._createMesh(O,n);var B=r.distanceToVector3(c,c).x,z=r.coordinateToVector3(o,B);return i.getObject3d().position.copy(z),i._params={index:0,chunkLines:p,geometries:[],layer:r,trail:Math.max(1,u),lineWidth:C,depth:T,speed:Math.min(1,h),idx:0,loaded:!1,positionMap:v,centerPt:d},i._init(i._params),i.type="ExtrudeLineTrail",i}var Be=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),ze=new tt.MeshBasicMaterial;ze.vertexColors=nt();function Pe(t){return i(e,n=t),e.prototype._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,n=t.length;e<n;e++){var r=t[e];this._proxyEvent(r)}return this},e.prototype._proxyEvent=function(t){var e=this;t.on("add",function(t){e._showGeometry(t.target,!0)}),t.on("remove",function(t){e._showGeometry(t.target,!1)}),t.on("mouseout",function(t){e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}),t.on(Be,function(t){e.fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})},e.prototype._getHideGeometryIndex=function(t){for(var e=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}},e.prototype._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];var a=NaN;this.getObject3d()instanceof tt.LineSegments&&(a=0);for(var s=0;s<n.length;s++)for(var c=n[s],h=this._geometriesAttributes[c][e],l=h.start,u=h.end,o=l;o<u;o++)t.array[o]=a;return this},e.prototype._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},e.prototype.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e.prototype._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},e.prototype._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},e.prototype._setPickObject3d=function(){for(var t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],i=0,o=n.length;i<o;i++){var a=e.getColor(),s=a.getHex(),c=n[this._colorMap[s]=i].position.count;this._datas[i].colorIndex=s;for(var h=0;h<c;h++)r.push(a.r,a.g,a.b)}et(t,"color",new tt.Float32BufferAttribute(r,3,!0));var l=e.getColor().getHex(),u=new tt.Mesh(t,ze);u.position.copy(this.getObject3d().position),u._colorIndex=l,this.setPickObject3d(u)},e;function e(){return null!==n&&n.apply(this,arguments)||this}var n}var ke,Ve,Ue,Ee="__maptalks.three__";function Ie(){return null!==Ve&&Ve.apply(this,arguments)||this}function Re(){return $.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),Ue=Ue||new ke(Ee)}$.worker&&(i(Ie,Ve=$.worker.Actor),Ie.prototype.test=function(t,e){this.send(t,null,e)},Ie.prototype.pushQueue=function(t){void 0===t&&(t={});var e,n=t.type,r=t.data,i=t.callback,o=t.layer,a=t.key,s=t.center,c=t.lineStrings;"Polygon"===n?e=function(t,e,n){void 0===t&&(t=[]);for(var r=t.length,i=[],o=[],a={},s=0;s<r;s++){for(var c=t[s],h=re(c,n,e,!0),l=0,u=h.length;l<u;l++)for(var f=h[l],p=0,d=f.length;p<d;p++)o.push(f[p]);var v=(kt(c)?c.properties:c.getProperties()||{}).height||1;null==a[v]&&(a[v]=n.distanceToVector3(v,v).x),v=a[v],i.push({data:h,height:v})}return{datas:i,transfer:o}}(r,s,o):"LineString"===n&&(e=function(t,e,n,r){for(var i=[],o=[],a={},s=t.length,c=0;c<s;c++){var h=t[c],l=Vt(r[c])?r[c].properties:r[c].getProperties()||{},u=l.width||1,f=l.height||1;null==a[f]&&(a[f]=n.distanceToVector3(f,f).x),null==a[u]&&(a[u]=n.distanceToVector3(u,u).x);for(var p=[],d=0,v=h.length;d<v;d++){for(var g=Dt(h[d],n,e).positionsV,y=new Float32Array(2*g.length),x=0,m=g.length;x<m;x++)y[2*x]=g[x].x,y[2*x+1]=g[x].y;o.push(y),p.push(y)}i.push({data:p,height:a[f],width:a[u]})}return{datas:i,transfer:o}}(r,s,o,c)),this.send({type:n,datas:e.datas},e.transfe,function(t,e){t&&console.error(t),e.key=a,i(e)})},ke=Ie);var Ze,Ge={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},Fe=(i(De,Ze=Pe(y)),De.prototype.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=Object.assign({},this.options,kt(t)?t.properties:t.getProperties(),{index:n}),this._baseObjects[n]=new fe(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},De.prototype.identify=function(t){return this.picked},De);function De(t,e,o,n){var a=this;Array.isArray(t)||(t=[t]);var r=t.length;0===r&&console.error("polygons is empty");for(var i=1/0,s=1/0,c=-1/0,h=-1/0,l=0;l<r;l++){var u=(L=t[l]).getCenter?L.getCenter():Rt(L),f=void 0,p=void 0;Array.isArray(u)?(f=u[0],p=u[1]):u instanceof $.Coordinate&&(f=u.x,p=u.y),i=Math.min(i,f),s=Math.min(s,p),c=Math.max(c,f),h=Math.max(h,p)}var d=new $.Coordinate((i+c)/2,(s+h)/2),v=(e=$.Util.extend({},Ge,e,{layer:n,polygons:t,coordinate:d})).topColor,g=e.bottomColor,y=e.altitude,x=e.asynchronous,m=[],b=[],_=[];if(x){var w=Re(),M=q();w.pushQueue({type:"Polygon",layer:n,key:e.key,center:d,data:t,callback:function(t){var e=t.faceMap,n=t.geometriesAttributes;a._faceMap=e,a._geometriesAttributes=n;var r=W(t);v&&(ne(r,g,v),o.vertexColors=nt());var i=a.getObject3d();i.geometry=r,i.material.needsUpdate=!0,a._geometryCache=r.clone(),a._setPickObject3d(),a._init(),a.isAdd&&a.getLayer().getPick().add(a.pickObject3d),a._fire("workerload",{target:a})}})}else{for(var O=[],S=0,j=0,A=0,C=0,T={},l=0;l<r;l++){var L,B=(kt(L=t[l])?L.properties:L.getProperties()||{}).height||1,z=ee(L,B,n,d,T);O.push(z);var P=z.position,k=z.normal,V=z.uv,U=z.indices.length/3;b[l]=[S+1,S+U],S+=U;var E=P.length/3,I=k.length/3,R=V.length/2;_[l]={position:{count:E,start:j,end:j+3*E},normal:{count:I,start:A,end:A+3*I},uv:{count:R,start:C,end:C+2*R},hide:!1},j+=3*E,A+=3*I,C+=2*R}M=F(O),v&&(ne(M,g,v),o.vertexColors=nt())}(a=Ze.call(this)||this)._initOptions(e),a._createMesh(M,o);var Z=n.distanceToVector3(y,y).x,G=n.coordinateToVector3(d,Z);return a.getObject3d().position.copy(G),a._faceMap=b,a._baseObjects=m,a._datas=t,a._geometriesAttributes=_,a.faceIndex=null,a._geometryCache=M.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(m),x||(a._setPickObject3d(),a._init()),a.type="ExtrudePolygons",a}function We(t,e,n){return void 0===t&&(t={}),t[e]||(t[e]=n.distanceToVector3(e,e).x),t[e]}function qe(t){void 0===t&&(t=[]);for(var e=1/0,n=1/0,r=-1/0,i=-1/0,o=0,a=t.length;o<a;o++){var s=t[o],c=s.coordinate,h=s.lnglat,l=s.lnglats,u=s.xy,f=s.xys,p=c||h||l||u||f||t[o],d=void 0,v=void 0;Array.isArray(p)?(d=p[0],v=p[1]):p instanceof $.Coordinate&&(d=p.x,v=p.y),e=Math.min(e,d),n=Math.min(n,v),r=Math.max(r,d),i=Math.max(i,v)}return new $.Coordinate((e+r)/2,(n+i)/2)}function He(t,e,n){var r=t.project(n),i=e.width/2,o=e.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var Ne,Ke=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,n,r,i){return void 0===r&&(r=0),t[0]instanceof tt.Vector3||(t=function(t,e,n){void 0===e&&(e=0);for(var r=[],i={},o=0,a=t.length;o<a;o+=3){var s=t[o],c=t[o+1],h=t[o+2];0<e&&(h+=We(i,e,n)),r.push(new tt.Vector3(s,c,h))}return r}(t,r,i)),t.map(function(t){return He(t,e,n)})},vector2Pixel:He}),Je={altitude:0,height:0,color:null},Qe=new tt.Vector3,Xe=(i(Ye,Ne=y),Ye.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size,s=this.getMap().coordToContainerPoint(t),c=e.distanceToVector3(o,o).x;Qe.x=i.x,Qe.y=i.y,Qe.z=i.z+c;var h=He(Qe,n,r);return Math.sqrt(Math.pow(s.x-h.x,2)+Math.pow(s.y-h.y,2))<=a/2},Ye);function Ye(t,e,n,r){var i=this;e=$.Util.extend({},Je,e,{layer:r,coordinate:t}),i=Ne.call(this)||this;var o=e.height,a=e.altitude,s=e.color,c=[],h=[];s&&(s=s instanceof tt.Color?s:new tt.Color(s),h.push(s.r,s.g,s.b));var l=r.distanceToVector3(o,o).x,u=r.coordinateToVector3(t,l);c.push(0,0,u.z);var f=new tt.BufferGeometry;et(f,"position",new tt.Float32BufferAttribute(c,3,!0)),h.length&&et(f,"color",new tt.Float32BufferAttribute(h,3,!0)),e.positions=u,i._initOptions(e),i._createPoints(f,n);var p=r.distanceToVector3(a,a).x,d=new tt.Vector3(u.x,u.y,p);return i.getObject3d().position.copy(d),i.type="Point",i}function $e(t,e){var n=t.minx,r=t.miny,i=t.maxx,o=t.maxy,a=e[0],s=e[1];return n<=a&&a<=i&&r<=s&&s<=o}var tn=(en.prototype.updateBBoxPixel=function(e){var n=1/0,r=1/0,i=-1/0,o=-1/0,t=this.minlng,a=this.minlat,s=this.maxlng,c=this.maxlat;return[[t,a],[t,c],[s,a],[s,c]].map(function(t){return new $.Coordinate(t)}).map(function(t){return e.coordToContainerPoint(t)}).forEach(function(t){n=Math.min(n,t.x),r=Math.min(r,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)}),this.minx=n,this.miny=r,this.maxx=i,this.maxy=o,this},en.prototype.containsCoordinate=function(t){var e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof $.Coordinate&&(e=t.x,n=t.y);var r=this.minlng,i=this.minlat,o=this.maxlng,a=this.maxlat;return r<=e&&e<=o&&i<=n&&n<=a},en.prototype.isRecCross=function(t,e){var n=t.x,r=t.y,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},o=i.minx,a=i.miny,s=i.maxx,c=i.maxy;return!!($e(this,[o,a])||$e(this,[o,c])||$e(this,[s,a])||$e(this,[s,c])||$e(i,[this.minx,this.miny])||$e(i,[this.minx,this.maxy])||$e(i,[this.maxx,this.miny])||$e(i,[this.maxx,this.maxy]))},en.initGrids=function(t,e,n,r){for(var i,o,a=[],s=(n-t)/30,c=(r-e)/30,h=0;h<30;h++){i=t+h*s;for(var l=0;l<30;l++){var u=new en(i,o=e+l*c,i+s,o+c);u.key=l+"-"+h,a.push(u)}}return a},en);function en(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var nn,rn={altitude:0},on=new tt.Vector3,an=(i(sn,nn=Pe(y)),sn.prototype._bindMapEvents=function(){var t=this,e=this.getMap(),n="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",function(){t._updateGrids(),e.on(n,t._updateGrids,t)}),this.on("remove",function(){e.off(n,t._updateGrids,t)})},sn.prototype._updateGrids=function(){var e=this.getMap();this._grids.forEach(function(t){t.indexs.length&&t.updateBBoxPixel(e)})},sn.prototype.getSelectMesh=function(){var t,e,n,r,i=this.faceIndex;if(null!=i)return this._baseObjects[i]||(e=(t=this._datas[i]).coordinate,n=t.height,r=t.color,this._baseObjects[i]=new Xe(e,{height:n,index:i,color:r},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[i])),{data:this._datas[i],baseObject:this._baseObjects[i]}},sn.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().altitude,o=this.getMap(),a=e.distanceToVector3(i,i).x,s=this.getObject3d().material.size,c=o.coordToContainerPoint(t),h=[];if(this._grids.forEach(function(t){t.indexs.length&&t.isRecCross(c,s)&&h.push(t)}),h.length<1)return!1;for(var l=0,u=h.length;l<u;l++)for(var f=0,p=h[l].positions.length;f<p;f++){var d=h[l].positions[f];on.x=d.x,on.y=d.y,on.z=d.z+a;var v=He(on,n,r);if(Math.sqrt(Math.pow(c.x-v.x,2)+Math.pow(c.y-v.y,2))<=s/2)return this.faceIndex=h[l].indexs[f],!0}return!1},sn);function sn(t,e,n,r){var i=this;Array.isArray(t)||(t=[t]),e=$.Util.extend({},rn,e,{layer:r,points:t});for(var o=1/0,a=1/0,s=-1/0,c=-1/0,h=0,l=t.length;h<l;h++){var u=t[h].coordinate,f=void 0,p=void 0;Array.isArray(u)?(f=u[0],p=u[1]):u instanceof $.Coordinate&&(f=u.x,p=u.y),o=Math.min(o,f),a=Math.min(a,p),s=Math.max(s,f),c=Math.max(c,p)}for(var d=r.coordinateToVector3([(o+s)/2,(a+c)/2]),v=tn.initGrids(o,a,s,c),g=v.length,y=[],x=[],m=[],b=[],_=[],w={},h=0,l=t.length;h<l;h++){var M=t[h],u=M.coordinate,O=M.height,S=M.color;S&&(S=S instanceof tt.Color?S:new tt.Color(S),m.push(S.r,S.g,S.b));var j=We(w,O,r),A=r.coordinateToVector3(u,j),C=A.clone().sub(d);y.push(C.x,C.y,C.z),x.push(A),_[h]={position:{count:1,start:3*h,end:3*h+3},hide:!1};for(var T=0;T<g;T++)if(v[T].containsCoordinate(u)){v[T].positions.push(A),v[T].indexs.push(h);break}}var L=new tt.BufferGeometry;et(L,"position",new tt.Float32BufferAttribute(y,3,!0)),m.length&&et(L,"color",new tt.Float32BufferAttribute(m,3,!0)),e.positions=x,(i=nn.call(this)||this)._initOptions(e),i._createPoints(L,n);var B=e.altitude,z=r.distanceToVector3(B,B).x,P=d.clone();return P.z=z,i.getObject3d().position.copy(P),i._baseObjects=b,i._datas=t,i.faceIndex=null,i._geometriesAttributes=_,i._geometryCache=L.clone(),i.isHide=!1,i._initBaseObjectsEvent(b),i._grids=v,i._bindMapEvents(),i.type="Points",i}var cn,hn={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"},ln=(i(un,cn=Pe(y)),un.prototype.identify=function(){return this.picked},un);function un(t,e,n,r){var i=this;Array.isArray(t)||(t=[t]);for(var o=t.length,a=qe(t),s=r.coordinateToVector3(a),c=[],h=[],l=[],u=[],f=0,p=0,d=0,v=0,g={},y=0;y<o;y++){var x=$.Util.extend({index:y},hn,t[y]),m=x.radius,b=x.radialSegments,_=x.altitude,w=x.topColor,M=x.bottomColor,O=x.height,S=x.coordinate,j=We(g,m,r),A=We(g,O,r),C=We(g,_,r),T=N({radius:j,height:A,radialSegments:b});w&&(K(T,M,w,"z",A/2),n.vertexColors=nt());for(var L=r.coordinateToVector3(S).sub(s),B=T.attributes.position.array,z=0,P=B.length;z<P;z+=3)B[z+2]+=C,B[z]+=L.x,B[z+1]+=L.y,B[z+2]+=L.z;c.push(T);var k=new Q(S,x,n,r);h.push(k);var V=T.index.count/3;u[y]=[f+1,f+V],f+=V;var U=T.attributes.position.count,E=T.attributes.normal.count,I=T.attributes.uv.count;l[y]={position:{count:U,start:p,end:p+3*U},normal:{count:E,start:d,end:d+3*E},uv:{count:I,start:v,end:v+2*I},hide:!1},p+=3*U,d+=3*E,v+=2*I}i=cn.call(this)||this,e=$.Util.extend({},{altitude:0,layer:r,points:t},e),i._initOptions(e);var R=J(c);i._createMesh(R,n);var Z=e.altitude,G=r.distanceToVector3(Z,Z).x,F=s.clone();return F.z=G,i.getObject3d().position.copy(F),i._faceMap=u,i._baseObjects=h,i._datas=t,i._geometriesAttributes=l,i.faceIndex=null,i._geometryCache=R.clone(),i.isHide=!1,i._colorMap={},i._initBaseObjectsEvent(h),i._setPickObject3d(),i._init(),i.type="Bars",i}var fn,pn={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"},dn=(i(vn,fn=Pe(y)),vn.prototype.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=Object.assign({},this.options,Vt(t)?t.properties:t.getProperties(),{index:n}),this._baseObjects[n]=new ce(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},vn.prototype.identify=function(t){return this.picked},vn);function vn(t,e,i,n){var o=this;Array.isArray(t)||(t=[t]);for(var r=[],a=[],s=t.length,c=0;c<s;c++){var h=Ht(S=t[c]);r.push(h.center),a.push(h.lineStrings)}var l=qe(r),u=(e=$.Util.extend({},pn,e,{layer:n,lineStrings:t,coordinate:l})).altitude,f=e.topColor,p=e.bottomColor,d=e.asynchronous,v=[],g=[];if(d){var y=Re(),x=q();y.pushQueue({type:"LineString",layer:n,key:e.key,center:l,data:a,lineStrings:t,callback:function(t){var e=t.faceMap,n=t.geometriesAttributes;o._faceMap=e,o._geometriesAttributes=n;var r=W(t);f&&(ne(r,p,f),i.vertexColors=nt()),o.getObject3d().geometry=r,o.getObject3d().material.needsUpdate=!0,o._geometryCache=r.clone(),o._setPickObject3d(),o._init(),o.isAdd&&o.getLayer().getPick().add(o.pickObject3d),o._fire("workerload",{target:o})}})}else{for(var m=[],b=0,_=[],w=0,M=0,O={},c=0;c<s;c++){for(var S=t[c],j=$.Util.extend({},pn,Pt(S)?S.properties:S.getProperties(),{index:c}),A=j.height,C=We(O,j.width,n),T=We(O,A,n),L=a[c],B=[],z=0,P=L.length;z<P;z++)B.push(qt(L[z],C,T,n,l));var k=D(B);m.push(k);var V=k.position,U=k.normal,E=k.indices.length/3;_[c]=[b+1,b+E],b+=E;var I=V.length/3,R=U.length/3;g[c]={position:{count:I,start:w,end:w+3*I},normal:{count:R,start:M,end:M+3*R},hide:!1},w+=3*I,M+=3*R}x=F(m),f&&(ne(x,p,f),i.vertexColors=nt())}(o=fn.call(this)||this)._initOptions(e),o._createMesh(x,i);var Z=n.distanceToVector3(u,u).x,G=n.coordinateToVector3(l,Z);return o.getObject3d().position.copy(G),o._faceMap=[],o._baseObjects=v,o._datas=t,o._geometriesAttributes=g,o.faceIndex=null,o._geometryCache=x.clone(),o.isHide=!1,o._colorMap={},o._initBaseObjectsEvent(v),d||(o._setPickObject3d(),o._init()),o.type="ExtrudeLines",o}var gn,yn={altitude:0,colors:null},xn=(i(mn,gn=Pe(y)),mn.prototype.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=$.Util.extend({},this.getOptions(),{index:n},Vt(t)?t.properties:t.getProperties()),this._baseObjects[n]=new Qt(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},mn.prototype._setPickObject3d=function(){for(var t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],i=0,o=n.length;i<o;i++){var a=e.getColor(),s=a.getHex(),c=n[this._colorMap[s]=i].position.count;this._datas[i].colorIndex=s;for(var h=0;h<c;h++)r.push(a.r,a.g,a.b)}et(t,"color",new tt.Float32BufferAttribute(r,3,!0));var l=this.getObject3d().material.clone();l.color.set("#fff"),l.vertexColors=nt();var u=e.getColor().getHex(),f=new tt.LineSegments(t,l);f.position.copy(this.getObject3d().position),f._colorIndex=u,this.setPickObject3d(f)},mn.prototype.identify=function(t){return this.picked},mn);function mn(t,e,n,r){var i=this;Array.isArray(t)||(t=[t]);for(var o=[],a=[],s=t.length,c=0;c<s;c++){var h=Ht(t[c]);o.push(h.center),a.push(h.lineStrings)}var l=qe(o);e=$.Util.extend({},yn,e,{layer:r,lineStrings:t,coordinate:l});for(var u=[],f=0,p=[],d=[],v=0,g=[],c=0;c<s;c++){for(var y=a[c],x=0,m=0,b=y.length;m<b;m++){var _=Dt(y[m],r,l).positionsV;x+=2*_.length-2;for(var w=0,M=_.length;w<M;w++){var O=_[w];0<w&&w<M-1&&g.push(O.x,O.y,O.z),g.push(O.x,O.y,O.z)}}var S=x;p[c]=[f,f+S],f+=S,d[c]={position:{count:x,start:v,end:v+3*x},hide:!1},v+=3*x}var j=new tt.BufferGeometry;et(j,"position",new tt.Float32BufferAttribute(g,3)),(i=gn.call(this)||this)._initOptions(e),i._createLineSegments(j,n);var A=e.altitude,C=r.distanceToVector3(A,A).x,T=r.coordinateToVector3(l,C);return i.getObject3d().position.copy(T),i._faceMap=p,i._baseObjects=u,i._datas=t,i._geometriesAttributes=d,i.faceIndex=null,i.index=null,i._geometryCache=j.clone(),i.isHide=!1,i._colorMap={},i._initBaseObjectsEvent(u),i._setPickObject3d(),i._init(),i.type="Lines",i}var bn=[],_n=[];function wn(t,e){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){var o=i.key,a=i.callback;if(e===o)return t.splice(n,1),a}}return null}var Mn=document.createElement("canvas");function On(t,e){void 0===e&&(e=!1);var n,r=Mn.getContext("2d");return r.clearRect(0,0,256,256),r.save(),e&&(r.fillStyle="red",r.strokeStyle="rgba(255,0,0,0.4)",r.lineWidth=.2,n=t||"tile",r.font="18px sans-serif",r.rect(0,0,256,256),r.stroke(),r.fillText(n,15,128)),Mn.toDataURL()}function Sn(t,e){var n;return void 0===t&&(t=1),void 0===e&&(e=1),"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}Mn.width=Mn.height=256;var jn,An=(i(Cn,jn=$.TileLayer),Cn.prototype.isAsynchronous=function(){return this._opts.worker},Cn.prototype.getBaseObjects=function(){var t=this._loadTiles,e=[];for(var n in t){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e},Cn.prototype.onSelectMesh=function(t,e){},Cn.prototype.formatBaseObjects=function(t,e){return[]},Cn.prototype.loopMessage=function(t){},Cn.prototype.getTileData=function(t){var n=t.key,e=t.url,r=t.callback,i=t.img;$.Ajax.getJSON(e,{},function(t,e){t?(console.error(t),r(n,null,i)):r(n,e,i)})},Cn.prototype._getCurentTileKeys=function(){for(var t=this.getTiles().tileGrids||[],e=[],n={},r=0,i=t.length;r<i;r++)for(var o=t[r].tiles||[],a=0,s=o.length;a<s;a++){var c=o[a].id;e.push(c),n[c]=!0}return{keys:e,keysMap:n}},Cn.prototype._isLoad=function(){var t=this._getCurentTileKeys().keys,e=Object.keys(this._renderer.tilesInView);return t.length===e.length},Cn.prototype._layerOnLoad=function(){var t=(new Date).getTime();if(!(t-this._layerLaodTime<20)){this._layerLaodTime=t;var e,n,r,i,o,a=this._renderer.tilesInView,s=this._loadTiles,c=this._layer,h=this._baseObjectKeys,l=Object.keys(a).length,u=Object.keys(s).length,f=[];if(l&&u)for(var p in s)a[p]||h[p]&&(h[p]||[]).forEach(function(t){f.push(t)});if(f.length&&c.removeMesh(f,!1),l&&u)for(var p in a)s[p]||(h[p]?(e=h[p],c.addMesh(e)):(r=(n=this._getXYZOfIndex(p)).x,i=n.y,o=n.z,this.getTileUrl(r,i,o)));this._loadTiles=Object.assign({},a),this._diffCache()}},Cn.prototype._init=function(){},Cn.prototype._workerLoad=function(t){var e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=On(e._key,this._opts.debug))},Cn.prototype._generateBaseObjects=function(t,e,n){var r=this;if(e&&n){if(!this._getCurentTileKeys().keysMap[t])return void(n.src=On(t,this._opts.debug));var i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length;for(var o=n.currentCount=0,a=i.length;o<a;o++){var s=i[o];s._img=n,(s._vt=this).isVisible()||s.hide(),this._cachetile(t,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=On(t,this._opts.debug)),this.isAsynchronous()?i.filter(function(t){return t.isAsynchronous()}).forEach(function(t){t.on("workerload",r._workerLoad,r)}):n.src=On(t,this._opts.debug)}else n.src=On(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=On(t,this._opts.debug))},Cn.prototype._diffCache=function(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){var t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(var r in this._baseObjectKeys)t[r]||e[r]||((this._baseObjectKeys[r]||[]).forEach(function(t){t.isAdd&&n.push(t)}),this._diposeBaseObject(r),delete this._baseObjectKeys[r]);n.length&&this._layer.removeMesh(n,!1)}},Cn.prototype._diposeBaseObject=function(t){var e=this._baseObjectKeys[t];e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();var e=t._baseObjects;e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t=null}),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null})},Cn.prototype._cachetile=function(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)},Cn.prototype._getXYZOfIndex=function(t){var e=-1<t.indexOf("_")?"_":"-",n=t.split(e).slice(1,4),r=n[0],i=n[1],o=n[2];return{x:parseInt(i),y:parseInt(r),z:parseInt(o)}},Cn.prototype._getTileExtent=function(t,e,n){var r=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,r)},Cn.prototype._getTileLngLatExtent=function(t,e,n){var r=this._getTileExtent(t,e,n),i=r.getMax(),o=r.getMin(),a=this.getMap().getProjection(),o=a.unproject(o),i=a.unproject(i);return new $.Extent(o,i)},Cn);function Cn(t,e){void 0===e&&(e={});var n=jn.call(this,$.Util.GUID(),$.Util.extend({urlTemplate:t},e))||this;return n._opts=null,n._layer=null,n.material=null,n.getMaterial=null,n._baseObjectKeys={},n._loadTiles={},n._add=null,n._layerLaodTime=(new Date).getTime(),n}var Tn,Ln={worker:!1},Bn=(i(zn,Tn=An),zn.prototype.formatBaseObjects=function(t,e){var n=this._opts,r=[],i=this.isAsynchronous();for(var o in e){var a=e[o]||{},s=void 0;if(Array.isArray(a)?s=a:"FeatureCollection"===a.type&&(s=a.features),s&&s.length){for(var c,h,l,u,f=[],p=[],d=[],v=0,g=s.length;v<g;v++){var y=s[v];if(kt(y))f.push(y);else if(Vt(y))for(var x=0,m=(b=Zt(y)).length;x<m;x++)p.push(b[x]);else if(Ut(y))for(var b,x=0,m=(b=Zt(y)).length;x<m;x++)d.push($.Util.extend({},b[x].properties,b[x],{coordinate:It(b[x])}))}f.length&&(l=this._getMaterial(o,f,t,a))&&(c=this._layer.toExtrudePolygons(f,$.Util.extend({},{topColor:"#fff",layerName:o,asynchronous:i,key:t},n),l),r.push(c)),p.length&&(l=this._getMaterial(o,p,t,a))&&(l instanceof tt.LineBasicMaterial||l instanceof tt.LineDashedMaterial)&&(h=this._layer.toLines(p,$.Util.extend({},{layerName:o},n),l),r.push(h)),d.length&&(l=this._getMaterial(o,d,t,a))&&l instanceof tt.PointsMaterial&&(u=this._layer.toPoints(d,$.Util.extend({},{layerName:o},n),l),r.push(u))}}return r},zn.prototype.loopMessage=function(t){0<{waitingQueue:bn,currentQueue:_n}.currentQueue.length&&this.getTileData(t)},zn.prototype._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){var t;!1===o._add&&(t=o.getBaseObjects(),o._layer.addMesh(t)),o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var t=o.getBaseObjects();o._layer.removeMesh(t),clearInterval(o.intervalId)}),this.on("show",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.show()}),o._baseObjectKeys)(o._baseObjectKeys[e]||[]).forEach(function(t){t.show()})}),this.on("hide",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.hide()}),o._baseObjectKeys)(o._baseObjectKeys[e]||[]).forEach(function(t){t.hide()})}),this.on("renderercreate",function(t){t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){var e,n,r;t&&t.image&&(t.image.onload=null,t.image.onerror=null,e=t.info||{},(r=wn(bn,n=e.id))&&r(n))},t.renderer.loadTileImage=function(t,e,n){var r,i;t._key=n,i={key:n,url:e,callback:function(t,e,n){var r,i;o._generateBaseObjects(t,e,n),r=o,wn(_n,t),bn.length&&(_n.push(bn[0]),bn.splice(0,1),i=_n[_n.length-1],r.loopMessage(i))},img:t,vt:r=o},_n.length<10?(_n.push(i),r.loopMessage(i)):bn.push(i)}})},zn.prototype._getMaterial=function(t,e,n,r){return this.getMaterial&&$.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,r):null},zn);function zn(t,e,n,r){void 0===e&&(e={});var i=Tn.call(this,$.Util.GUID(),$.Util.extend({urlTemplate:t},Ln,e))||this;return i._opts=e,i._layer=r,i.getMaterial=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._layerLaodTime=(new Date).getTime(),i._init(),i}var Pn=new tt.TextureLoader,kn=document.createElement("canvas"),Vn=256;function Un(t){return t?("string"==typeof t?(e=new Image).src=t:t instanceof HTMLCanvasElement?(e=new Image).src=t.toDataURL():t instanceof Image&&((e=new Image).src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e):null;var e}var En,In={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null},Rn=(i(Zn,En=y),Zn);function Zn(t,e,a,s){var n=this,r=(e=$.Util.extend({},In,e,{layer:s,extent:t})).texture,i=e.image,o=e.altitude,c=e.imageHeight,h=e.imageWidth;i||console.error("not find image"),t instanceof $.Extent||(t=new $.Extent(t));var l=t.xmin,u=t.ymin,f=t.xmax,p=t.ymax,d=1/0,v=1/0,g=-1/0,y=-1/0;[[l,u],[l,p],[f,p],[f,u]].forEach(function(t){var e=s.coordinateToVector3(t),n=e.x,r=e.y;d=Math.min(n,d),v=Math.min(r,v),g=Math.max(n,g),y=Math.max(r,y)});var x=Math.abs(g-d),m=Math.abs(y-v),b=Un(i),_=Un(r),w=new tt.PlaneBufferGeometry(x,m,h-1,c-1);(n=En.call(this)||this)._initOptions(e),n._createMesh(w,a);var M=s.distanceToVector3(o,o).x,O=s.coordinateToVector3(t.getCenter(),M);return n.getObject3d().position.copy(O),a.transparent=!0,b&&(a.opacity=0,b.onload=function(){for(var t=function(t,e,n){void 0===e&&(e=Vn),void 0===n&&(n=Vn),kn.width=e,kn.height=n;var r=kn.getContext("2d");return r.drawImage(t,0,0,e,n),r.getImageData(0,0,e,n).data}(b,h,c),e=0,n={},r=0,i=t.length;r<i;r+=4){var o=We(n,.1*(256*t[r]*256+256*t[r+1]+t[r+2])-1e4,s);w.attributes.position.array[3*e+2]=o,e++}w.attributes.position.needsUpdate=!0,_?Pn.load(_.src,function(t){a.map=t,a.opacity=1,a.needsUpdate=!0}):a.opacity=1},b.onerror=function(){console.error("not load "+b.src)}),n.type="Terrain",n}var Gn,Fn={scale:1,tileDivisor:4},Dn=(i(Wn,Gn=An),Wn.prototype.isAsynchronous=function(){return!1},Wn.prototype.formatBaseObjects=function(t,e){var n,r=this.options,i=[],o=r.scale,a=r.tileDivisor,s=this._getXYZOfIndex(t),c=s.x,h=s.y,l=s.z,u=this.getMap().getZoom(),f=this.getTileUrl(c,h,l),p=this.options.tileSize,d=p[0],v=p[1],g=this._getTileLngLatExtent(c,h,l),y=this.material.clone();return l+1>=Math.round(u)&&((n=new Rn(g,{image:e,imageWidth:d/a,imageHeight:v/a,texture:f},y,this._layer)).getObject3d().scale.set(o,o,1),i.push(n)),i},Wn.prototype.loopMessage=function(t){this.getTileData(t)},Wn.prototype._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){var t;!1===o._add&&(t=o.getBaseObjects(),o._layer.addMesh(t)),o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var t=o.getBaseObjects();o._layer.removeMesh(t),clearInterval(o.intervalId)}),this.on("show",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.show()}),o._baseObjectKeys)(o._baseObjectKeys[e]||[]).forEach(function(t){t.show()})}),this.on("hide",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.hide()}),o._baseObjectKeys)(o._baseObjectKeys[e]||[]).forEach(function(t){t.hide()})}),this.on("renderercreate",function(t){t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){var e,n;t&&t.image&&(t.image.onload=null,t.image.onerror=null,e=t.info||{},(n=o._imgQueue[e.id])&&(n.src="",n.onload=null,n.onerror=null,delete o._imgQueue[e.id]))},t.renderer.loadTileImage=function(t,e,n){t._key=n;var r=new Image,i={key:n,url:e,rgbImage:o._imgQueue[n]=r,callback:function(t,e,n){o._generateBaseObjects(t,e,n)},img:t,vt:o};o.loopMessage(i)}})},Wn);function Wn(t,e,n,r){void 0===e&&(e={});var i=Gn.call(this,$.Util.GUID(),$.Util.extend({urlTemplate:t},Fn,e))||this;return i._opts=e,i._layer=r,i.material=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._imgQueue={},i._layerLaodTime=(new Date).getTime(),i._init(),i}function qn(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function Hn(t,e,n){var r=Nn(n),i=n.min||0,o=r-i,a=n.range||null,s=0,c=1024;a&&2===a.length&&(s=(a[0]-i)/o*1024),a&&2===a.length&&(c=(a[1]-i)/o*1024);for(var h,l=n.maxOpacity||.8,u=n.minOpacity||0,f=3,p=t.length;f<p;f+=4)h=4*t[f],t[f]/256>l&&(t[f]=256*l),t[f]/256<u&&(t[f]=256*u),h&&s<=h&&h<=c?(t[f-3]=e[h],t[f-2]=e[1+h],t[f-1]=e[2+h]):t[f]=0}function Nn(t){return t.max||100}function Kn(r,t,e){var n,i,o,a,s,c,h=Nn(e),l=e._size||e.size||13,u=(a=Sn(2*(o=(n=l)+(i=n/2)),2*o),(s=a.getContext("2d")).shadowBlur=i,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=1e4,s.beginPath(),s.arc(o-1e4,o-1e4,n,0,2*Math.PI,!0),s.closePath(),s.fill(),a),f=u.width/2,p=u.height/2,d=t,v={};for(var g in d.forEach(function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/h).toFixed(2);v[n]=v[n]||[],v[n].push(t)}),v){isNaN(g)||(c=v[g],r.beginPath(),e.withoutAlpha||(r.globalAlpha=g),c.forEach(function(t){var e=t.coordinate,n=void 0===t.count?1:t.count;r.globalAlpha=n/h,r.drawImage(u,e[0]-f,e[1]-p)}))}}qn.prototype.setMax=function(t){this.max=t||100},qn.prototype.setMin=function(t){this.min=t||0},qn.prototype.setMaxSize=function(t){this.maxSize=t||35},qn.prototype.setMinSize=function(t){this.minSize=t||0},qn.prototype.initPalette=function(){var t=this.gradient,e=Sn(256,1),n=this.paletteCtx=e.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in t)r.addColorStop(parseFloat(i),t[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},qn.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},qn.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,r=this.min;n<t&&(t=n),t<r&&(t=r);var i=4*Math.floor((t-r)/(n-r)*255);return[e[i],e[1+i],e[2+i],e[3+i]]},qn.prototype.getSize=function(t){var e=this.max,n=this.min,r=this.maxSize,i=this.minSize;return e<t&&(t=e),t<n&&(t=n),n<e?i+(t-n)/(e-n)*(r-i):r};var Jn,Qn={draw:function(t,e,n){var r,i,o,a;t.canvas.width<=0||t.canvas.height<=0||(r=n.strength||.3,t.strokeStyle="rgba(0,0,0,"+r+")",(i=Sn(t.canvas.width,t.canvas.height).getContext("2d")).scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save(),o=new qn({gradient:n.gradient}),Kn(i,e,n),n.absolute||(Hn((a=i.getImageData(0,0,t.canvas.width,t.canvas.height)).data,o.getImageData(),n),t.putImageData(a,0,0),t.restore()),o=null)},drawGray:Kn,colorize:Hn},Xn={altitude:0,interactive:!(qn.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,r=t.height||180,i=Sn(n,r),o=i.getContext("2d"),a=o.createLinearGradient(0,r,0,0);for(var s in e)a.addColorStop(parseFloat(s),e[s]);return o.fillStyle=a,o.fillRect(0,0,n,r),i}),min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},Yn=(i($n,Jn=y),$n);function $n(t,e,n,r){var i=this;Array.isArray(t)||(t=[t]);for(var o=1/0,a=1/0,s=-1/0,c=-1/0,h=[],l=0,u=t.length;l<u;l++){var f,p,d=t[l],v=d.coordinate,g=d.lnglat,y=d.xy,x=v||g||y;x?(O=r.coordinateToVector3(x),h.push(O),f=O.x,p=O.y,o=Math.min(o,f),a=Math.min(a,p),s=Math.max(s,f),c=Math.max(c,p)):console.warn("not find coordinate")}var m=(e=$.Util.extend({},Xn,e,{layer:r,points:t})).gridScale,b=e.altitude,_=Math.abs(s-o),w=Math.abs(c-a),M=Math.max(_*m,w*m);2048<M&&(console.warn("gridScale: "+m+" it's too big. I hope it's a smaller value,canvas max size is 2048* 2048"),m=2048/(M/m));for(var O,S=Math.ceil(_*m),j=Math.ceil(w*m),A=S/_,C=j/w,T=[],l=0,u=h.length;l<u;l++){(O=h[l]).x-=o,O.y-=a,O.x*=A,O.y*=C,O.y=j-O.y,T.push({coordinate:[O.x,O.y],count:t[l].count})}var L=Sn(S,j).getContext("2d");Qn.drawGray(L,T,e);for(var B=L.getImageData(0,0,L.canvas.width,L.canvas.height),z=-1/0,P={},k=[],l=3,u=B.data.length,V=0;l<u;l+=4){var U=B.data[l],z=Math.max(z,U);k.push(U),U<=0&&(P[V]=1),V++}var E=new qn({gradient:e.gradient});Qn.colorize(B.data,E.getImageData(),e),L=null;for(var I,R,Z,G,F=new tt.PlaneBufferGeometry(_,w,S-1,j-1),D=F.getIndex().array,W=F.attributes.position.array,q=[],H=[],N=new tt.Color,l=0,u=W.length,V=0,K=D.length,J=0,Q=B.data.length,X=0;l<Math.max(u,K,Q);l+=3){l<u&&0<(U=k[X])&&(W[l+2]=U/z),V<K&&(I=D[V],Z=D[V+1],R=D[V+2],P[I]&&P[Z]&&P[R]||q.push(I,Z,R)),J<Q&&(G="rgb("+B.data[J]+","+B.data[J+1]+","+(Z=B.data[J+2])+")",N.setStyle(G),H.push(N.r,N.g,N.b)),V+=3,J+=4,X++}F.setIndex(new tt.Uint32BufferAttribute(q,1)),et(F,"color",new tt.Float32BufferAttribute(H,3,!0)),n.vertexColors=nt(),(i=Jn.call(this)||this)._initOptions(e),i._createMesh(F,n);var Y=r.distanceToVector3(b,b).x;return i.getObject3d().position.copy(new tt.Vector3((o+s)/2,(a+c)/2,Y)),i.type="HeatMap",i}var tr=new tt.Color,er=1,nr=(rr.prototype.getColor=function(){return tr.setHex(er),er++,tr},rr.prototype.add=function(t){var e;return!t||(e=t._colorIndex)&&(this.object3ds[e]=t,this.pickingScene.add(t)),this},rr.prototype.remove=function(t){var e;return!t||(e=t._colorIndex)&&(this.object3ds[e]=null,this.pickingScene.remove(t)),this},rr.prototype.isEmpty=function(){if(0===this.pickingScene.children.length)return!0;for(var t=0,e=this.pickingScene.children.length;t<e;t++){var n=this.pickingScene.children[t];if(n){var r=n.__parent;if(r&&!0===r.getOptions().interactive)return!1}}return!0},rr.prototype.pick=function(t){if(t&&!this.isEmpty()){for(var e=this,n=e.camera,r=e.renderer,i=e.pickingTexture,o=e.pickingScene,a=e.object3ds,s=e.layer,c=this.pickingScene.children.length,h=0;h<c;h++){var l=this.pickingScene.children[h];l&&l.__parent&&(l.__parent.picked=!1)}var u=s._getRenderer().canvas,f=u.width,p=u.height,d=i.width,v=i.height;f===d&&p===v||i.setSize(f,p),r.setRenderTarget(i),r.clear(),r.render(o,n);var g=new Uint8Array(4),y=t.x,x=t.y,m=window.devicePixelRatio,b=y*m,_=i.height-x*m;r.readRenderTargetPixels(i,Math.round(b),Math.round(_),1,1,g);var w=g[0]<<16|g[1]<<8|g[2],M=a[w];if(M)M.__parent&&(a[w].__parent.picked=!0);else for(h=0;h<c;h++){var O=this.pickingScene.children[h];if(O&&O.__parent){var S=O.__parent;if(S._colorMap&&null!=S._colorMap[w]){S.picked=!0,S.index=S._colorMap[w];break}}}r.setRenderTarget(null)}},rr);function rr(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new tt.WebGLRenderTarget(1,1),this.pickingScene=new tt.Scene}var ir,or={altitude:0},ar=(i(sr,ir=y),sr.prototype._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},sr.prototype._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},sr.prototype._setPickObject3d=function(t,e){var n=new L;n.setPositions(t);for(var r=this.getLayer().getPick().getColor(),i=[],o=0,a=t.length/3;o<a;o++)i.push(r.r,r.g,r.b);n.setColors(i);var s=new v({color:"#fff",linewidth:e,vertexColors:nt()});this._setMaterialRes(this.getLayer(),s);var c=r.getHex(),h=new g(n,s);h.position.copy(this.getObject3d().position),h._colorIndex=c,this.setPickObject3d(h)},sr.prototype.identify=function(t){return this.picked},sr.prototype.setSymbol=function(t){var e,n,r;return t&&t instanceof tt.Material&&(t.needsUpdate=!0,n=(e=this.getMap().getSize()).width,r=e.height,t.resolution.set(n,r),this.getObject3d().material=t),this},sr);function sr(t,e,n,r){var i=this;e=$.Util.extend({},or,e,{layer:r,lineString:t}),(i=ir.call(this)||this)._initOptions(e);for(var o=Ht(t),a=o.lineStrings,s=o.center,c=[],h=0,l=a.length;h<l;h++)for(var u=Dt(a[h],r,s).positionsV,f=0,p=u.length;f<p;f++){var d=u[f];0<f&&f<p-1&&c.push(d.x,d.y,d.z),c.push(d.x,d.y,d.z)}var v=new L;v.setPositions(c),i._setMaterialRes(r,n),i._createLine2(v,n);var g=e.altitude,y=r.distanceToVector3(g,g).x,x=r.coordinateToVector3(s,y);return i.getObject3d().position.copy(x),i._setPickObject3d(c,n.linewidth),i._init(),i.type="FatLine",i}var cr,hr={altitude:0,colors:null},lr=(i(ur,cr=Pe(y)),ur.prototype._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},ur.prototype._setPickObject3d=function(t,e){var n=this._geometryCache||new L;n.setPositions(t);for(var r=this.getLayer().getPick(),i=this._geometriesAttributes,o=[],a=0,s=i.length;a<s;a++){var c=r.getColor(),h=c.getHex(),l=i[this._colorMap[h]=a].position.count;this._datas[a].colorIndex=h;for(var u=0;u<l;u++)o.push(c.r,c.g,c.b)}n.setColors(o);var f=new v({color:"#fff",linewidth:e,vertexColors:nt()});this._setMaterialRes(this.getLayer(),f);var p=r.getColor().getHex(),d=new g(n,f);d.position.copy(this.getObject3d().position),d._colorIndex=p,this.setPickObject3d(d)},ur.prototype.identify=function(t){return this.picked},ur.prototype.setSymbol=function(t){var e,n,r;return t&&t instanceof tt.Material&&(t.needsUpdate=!0,n=(e=this.getMap().getSize()).width,r=e.height,t.resolution.set(n,r),this.getObject3d().material=t),this},ur.prototype.getSelectMesh=function(){var t,e,n=this._getIndex();if(null!=n)return this._baseObjects[n]||(t=this._datas[n],e=$.Util.extend({},this.getOptions(),{index:n},Vt(t)?t.properties:t.getProperties()),this._baseObjects[n]=new ar(t,e,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[n])),{data:this._datas[n],baseObject:this._baseObjects[n]}},ur.prototype._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];for(var a=0;a<n.length;a++)for(var s=n[a],c=this._geometriesAttributes[s][e],h=c.start,l=c.end,o=h;o<l;o++)t.array[o]=-1e5;return this},ur.prototype._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.instanceStart,"instanceStart"),this._updateAttribute(i.attributes.instanceEnd,"instanceEnd"),i.attributes.instanceStart.data.needsUpdate=!0,i.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this},ur);function ur(t,e,n,r){var i=this;Array.isArray(t)||(t=[t]);for(var o=[],a=[],s=t.length,c=0;c<s;c++){var h=Ht(t[c]);o.push(h.center),a.push(h.lineStrings)}var l=qe(o);e=$.Util.extend({},hr,e,{layer:r,lineStrings:t,coordinate:l});for(var u=[],f=0,p=[],d=[],v=0,g=[],c=0;c<s;c++){for(var y=a[c],x=0,m=0,b=y.length;m<b;m++){var _=Dt(y[m],r,l).positionsV;x+=2*_.length-2;for(var w=0,M=_.length;w<M;w++){var O=_[w];0<w&&w<M-1&&g.push(O.x,O.y,O.z),g.push(O.x,O.y,O.z)}}var S=x;p[c]=[f,f+S],f+=S,d[c]={position:{count:x,start:v,end:v+3*x},instanceStart:{count:x,start:v,end:v+3*x},instanceEnd:{count:x,start:v,end:v+3*x},hide:!1},v+=3*x}(i=cr.call(this)||this)._initOptions(e);var j=new L;j.setPositions(g),i._setMaterialRes(r,n),i._createLine2(j,n);var A=e.altitude,C=r.distanceToVector3(A,A).x,T=r.coordinateToVector3(l,C);return i.getObject3d().position.copy(T),i._faceMap=p,i._baseObjects=u,i._datas=t,i._geometriesAttributes=d,i.faceIndex=null,i.index=null,i._geometryCache=new L,i._geometryCache.setPositions(g),i._colorMap={},i.isHide=!1,i._initBaseObjectsEvent(u),i._setPickObject3d(g,n.linewidth),i._init(),i.type="FatLines",i}var fr,pr={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61"},dr=(i(vr,fr=y),vr);function vr(t,e,n,r){var i=this;e=$.Util.extend({},pr,e,{layer:r,coordinate:t}),(i=fr.call(this)||this)._initOptions(e);var o=e.height,a=e.radius,s=e.topColor,c=e.bottomColor,h=e.altitude,l=r.distanceToVector3(o,o).x,u=r.distanceToVector3(a,a).x,f=H.clone();f.scale(2*u,2*u,l),s&&(K(f,c,s,"z",l/2),n.vertexColors=nt()),i._createMesh(f,n);var p=r.distanceToVector3(h,h).x,d=r.coordinateToVector3(t,p);return i.getObject3d().position.copy(d),i.type="Box",i}var gr,yr={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"},xr=(i(mr,gr=Pe(y)),mr.prototype.identify=function(t){return this.picked},mr);function mr(t,e,n,r){var i=this;Array.isArray(t)||(t=[t]);for(var o=t.length,a=qe(t),s=r.coordinateToVector3(a),c=[],h=[],l=[],u=[],f=0,p=0,d=0,v=0,g={},y=0;y<o;y++){var x=$.Util.extend({index:y},yr,t[y]),m=x.radius,b=x.altitude,_=x.topColor,w=x.bottomColor,M=x.height,O=x.coordinate,S=We(g,m,r),j=We(g,M,r),A=We(g,b,r),C=H.clone();C.scale(2*S,2*S,j),_&&(K(C,w,_,"z",j/2),n.vertexColors=nt());for(var T=r.coordinateToVector3(O).sub(s),L=C.attributes.position.array,B=0,z=L.length;B<z;B+=3)L[B+2]+=A,L[B]+=T.x,L[B+1]+=T.y,L[B+2]+=T.z;c.push(C);var P=new dr(O,x,n,r);h.push(P);var k=C.index.count/3;u[y]=[f+1,f+k],f+=k;var V=C.attributes.position.count,U=C.attributes.normal.count,E=C.attributes.uv.count;l[y]={position:{count:V,start:p,end:p+3*V},normal:{count:U,start:d,end:d+3*U},uv:{count:E,start:v,end:v+2*E},hide:!1},p+=3*V,d+=3*U,v+=2*E}i=gr.call(this)||this,e=$.Util.extend({},{altitude:0,layer:r,points:t},e),i._initOptions(e);var I=J(c);i._createMesh(I,n);var R=e.altitude,Z=r.distanceToVector3(R,R).x,G=s.clone();return G.z=Z,i.getObject3d().position.copy(G),i._faceMap=u,i._baseObjects=h,i._datas=t,i._geometriesAttributes=l,i.faceIndex=null,i._geometryCache=I.clone(),i.isHide=!1,i._colorMap={},i._initBaseObjectsEvent(h),i._setPickObject3d(),i._init(),i.type="Boxs",i}var br,_r=Math.PI/180,wr=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Mr=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Or=(i(Sr,br=$.CanvasLayer),Sr.prototype.isRendering=function(){var t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())},Sr.prototype.prepareToDraw=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},Sr.prototype.draw=function(){this.renderScene()},Sr.prototype.drawOnInteracting=function(){this.renderScene()},Sr.prototype.coordinateToVector3=function(t,e){void 0===e&&(e=0);var n=this.getMap();if(!n)return null;t instanceof $.Coordinate||(t=new $.Coordinate(t));var r=n.coordinateToPoint(t,Tr(n));return new tt.Vector3(r.x,r.y,e)},Sr.prototype.distanceToVector3=function(t,e,n){if(0===t&&0===e||!$.Util.isNumber(t)||!$.Util.isNumber(e))return new tt.Vector3(0,0,0);var r=this.getMap(),i=Tr(r),o=n||r.getCenter();o instanceof $.Coordinate||(o=new $.Coordinate(o));var a=r.locate(o,t,e),s=r.coordinateToPoint(o,i),c=r.coordinateToPoint(a,i),h=Math.abs(c.x-s.x)*$.Util.sign(t),l=Math.abs(c.y-s.y)*$.Util.sign(e);return new tt.Vector3(h,l,0)},Sr.prototype.toShape=function(t){var n=this;if(!t)return null;if(t instanceof $.MultiPolygon)return t.getGeometries().map(function(t){return n.toShape(t)});var e=t.getCenter(),r=this.coordinateToVector3(e),i=t.getShell().map(function(t){var e=n.coordinateToVector3(t).sub(r);return new tt.Vector2(e.x,e.y)}),o=new tt.Shape(i),a=t.getHoles();return a&&0<a.length&&(o.holes=a.map(function(t){var e=t.map(function(t){var e=n.coordinateToVector3(t).sub(r);return new tt.Vector2(e.x,e.y)});return new tt.Shape(e)})),o},Sr.prototype.toExtrudeMesh=function(t,e,n,r){var i=this;if(!t)return null;if(t instanceof $.MultiPolygon)return t.getGeometries().map(function(t){return i.toExtrudeMesh(t,e,n,r)});var o=t.getCoordinates();o.forEach(function(t){for(var e=t.length-1;1<=e;e--)t[e].equals(t[e-1])&&t.splice(e,1)}),t.setCoordinates(o);var a=this.toShape(t),s=this.coordinateToVector3(t.getCenter());r=$.Util.isNumber(r)?r:e,r=this.distanceToVector3(r,r).x;var c=this.distanceToVector3(e,e).x,h={bevelEnabled:!1,bevelSize:1};h[93<=parseInt(tt.REVISION)?"depth":"amount"]=r;var l=new tt.ExtrudeGeometry(a,h),u=l;tt.BufferGeometry.prototype.fromGeometry&&(u=new tt.BufferGeometry).fromGeometry(l);var f=new tt.Mesh(u,n);return f.position.set(s.x,s.y,c-r),f},Sr.prototype.toExtrudePolygon=function(t,e,n){return new fe(t,e,n,this)},Sr.prototype.toBar=function(t,e,n){return new Q(t,e,n,this)},Sr.prototype.toLine=function(t,e,n){return new Qt(t,e,n,this)},Sr.prototype.toExtrudeLine=function(t,e,n){return new ce(t,e,n,this)},Sr.prototype.toModel=function(t,e){return new ge(t,e,this)},Sr.prototype.toExtrudeLineTrail=function(t,e,n){return new Te(t,e,n,this)},Sr.prototype.toExtrudePolygons=function(t,e,n){return new Fe(t,e,n,this)},Sr.prototype.toPoint=function(t,e,n){return new Xe(t,e,n,this)},Sr.prototype.toPoints=function(t,e,n){return new an(t,e,n,this)},Sr.prototype.toBars=function(t,e,n){return new ln(t,e,n,this)},Sr.prototype.toExtrudeLines=function(t,e,n){return new dn(t,e,n,this)},Sr.prototype.toLines=function(t,e,n){return new xn(t,e,n,this)},Sr.prototype.toThreeVectorTileLayer=function(t,e,n){return new Bn(t,e,n,this)},Sr.prototype.toTerrain=function(t,e,n){return new Rn(t,e,n,this)},Sr.prototype.toTerrainVectorTileLayer=function(t,e,n){return new Dn(t,e,n,this)},Sr.prototype.toHeatMap=function(t,e,n){return new Yn(t,e,n,this)},Sr.prototype.toFatLine=function(t,e,n){return new ar(t,e,n,this)},Sr.prototype.toFatLines=function(t,e,n){return new lr(t,e,n,this)},Sr.prototype.toBox=function(t,e,n){return new dr(t,e,n,this)},Sr.prototype.toBoxs=function(t,e,n){return new xr(t,e,n,this)},Sr.prototype.getBaseObjects=function(){return this.getMeshes().filter(function(t){return t instanceof y})},Sr.prototype.getMeshes=function(){var t=this.getScene();if(!t)return[];for(var e=[],n=0,r=t.children.length;n<r;n++){var i=t.children[n];i instanceof tt.Object3D&&!(i instanceof tt.Camera)&&e.push(i.__parent||i)}return e},Sr.prototype.clear=function(){return this.clearMesh()},Sr.prototype.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;0<=e;e--){var n,r=t.children[e];r instanceof tt.Object3D&&!(r instanceof tt.Camera)&&(t.remove(r),(n=r.__parent)&&n instanceof y&&(n.isAdd=!1,n._fire("remove",{target:n}),delete this._animationBaseObjectMap[r.uuid]))}return this},Sr.prototype.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},Sr.prototype.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},Sr.prototype.getScene=function(){var t=this._getRenderer();return t?t.scene:null},Sr.prototype.renderScene=function(){var t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene()),this},Sr.prototype.loop=function(t){void 0===t&&(t=!0);var e,n,r,i=this._delayMeshes;i.length&&(!(e=this.getMap())||e.isAnimating()||e.isInteracting()||(n=this.options.loopRenderCount||50,(r=i.slice(0,n))&&this.addMesh(r,t),i.splice(0,n)))},Sr.prototype.renderPickScene=function(){var t,e=this._getRenderer();return!e||(t=e.pick)&&t.pick(this._containerPoint),this},Sr.prototype.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},Sr.prototype.getPick=function(){var t=this._getRenderer();return t?t.pick:null},Sr.prototype.delayAddMesh=function(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(var e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this},Sr.prototype.addMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof y?(r.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&$.Util.isFunction(t._animation)&&(n._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof tt.Object3D&&r.add(t)}),this._zoomend(),e&&this.renderScene(),this},Sr.prototype.removeMesh=function(t,e){var i=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var o=this.getScene();return t.forEach(function(t){if(t instanceof y){o.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&$.Util.isFunction(t._animation)&&delete i._animationBaseObjectMap[t.getObject3d().uuid];var e=i._delayMeshes;if(e.length)for(var n=0,r=e.length;n<r;n++)if(e[n]===t){e.splice(n,1);break}}else t instanceof tt.Object3D&&o.remove(t)}),e&&this.renderScene(),this},Sr.prototype._initRaycaster=function(){return this._raycaster||(this._raycaster=new tt.Raycaster,this._mouse=new tt.Vector2),this},Sr.prototype.identify=function(e,t){var r=this;if(!e)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(e)&&(e=new $.Coordinate(e)),!(e instanceof $.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var n=this.getMap().coordToContainerPoint(e),i=(this._containerPoint=n).x,o=n.y;this._initRaycaster();var a=this._raycaster,s=this._mouse,c=this.getCamera(),h=this.getScene(),l=this.getMap().getSize();if(!h)return[];var u,f,p=l.width,d=l.height;s.x=i/p*2-1,s.y=-o/d*2+1,a.setFromCamera(s,c),u=a,f=this._getLinePrecision(this.getMap().getResolution()),113<M?u.params.Line.threshold=f:u.linePrecision=f;var v=[],g=[];h.children.forEach(function(t){var e,n=t.__parent;n&&n.getOptions?(e=n).getOptions().interactive&&e.isVisible()&&(e.identify&&$.Util.isFunction(e.identify)?g.push(e):v.push(t)):(t instanceof tt.Mesh||t instanceof tt.Group)&&v.push(t)});var y=[],x=a.intersectObjects(v,!0);x&&Array.isArray(x)&&x.length&&(y=x.map(function(t){var e=t.object,n=(e=r._recursionMesh(e)||{}).__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n})),this.renderPickScene(),g.length&&g.forEach(function(t){t.identify(e)&&y.push(t)});for(var m=y.length,b=0;b<m;b++)if(y[b])for(var _=b+1;_<m;_++)y[b]===y[_]&&y.splice(_,1);var w=(t=$.Util.extend({},t)).count;return $.Util.isNumber(w)&&0<w?y.slice(0,w):y},Sr.prototype._recursionMesh=function(t){for(;t&&!(t.parent instanceof tt.Scene);)t=t.parent;return t},Sr.prototype._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,n=wr.length;e<n;e++){var r=wr[e],i=r[0],o=r[1];if(i<t)return o}return.01},Sr.prototype._identifyBaseObjectEvents=function(n){if(!this.options.geometryEvents)return this;var t=this.map||this.getMap(),r=n.type,i=n.coordinate,e=$.Util.now();if(this._mousemoveTimeOut&&"mousemove"===r&&e-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=e,t.resetCursor("default");var o=this.options.identifyCountOnEvent,a=Math.max(0,$.Util.isNumber(o)?o:0);0===a&&(a=1/0);var s,c=this.identify(i,{count:a}),h=this.getScene();if(0===c.length&&h)for(var l=0,u=h.children.length;l<u;l++){var f=(h.children[l]||{}).__parent;f&&f.fire("empty",Object.assign({},n,{target:f}))}return"mousemove"===r?(c.length&&t.setCursor("pointer"),s=[],this._baseObjects&&this._baseObjects.forEach(function(e){var n=!0;c.forEach(function(t){e===t&&(n=!1)}),n&&s.push(e)}),s.forEach(function(t){t&&t instanceof y&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout"})),t.closeToolTip()))}),c.forEach(function(t){var e;t instanceof y&&(t._mouseover||(t.fire("mouseover",Object.assign({},n,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0),t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),(e=t.getToolTip())&&!e._owner&&e.addTo(t),t.openToolTip(i))}),this._baseObjects=c):c.forEach(function(t){var e;t instanceof y&&(t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),"click"===r&&((e=t.getInfoWindow())&&!e._owner&&e.addTo(t),t.openInfoWindow(i)))}),this},Sr.prototype._zoomend=function(){var o,t=this.getScene();t&&(o=this.getMap().getZoom(),t.children.forEach(function(t){var e,n,r,i=t.__parent;i&&i.getOptions&&((e=i).zoomChange&&$.Util.isFunction(e.zoomChange)&&e.zoomChange(o),n=e.getMinZoom(),r=e.getMaxZoom(),o<n||r<o?(e.isVisible()&&(e.getObject3d().visible=!1),e._zoomVisible=!1):n<=o&&o<=r&&(e._visible&&(e.getObject3d().visible=!0),e._zoomVisible=!0))}))},Sr.prototype.onAdd=function(){var e=this;br.prototype.onAdd.call(this);var n=this.map||this.getMap();return n&&(Mr.forEach(function(t){n.on(t,e._identifyBaseObjectEvents,e)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this)),this},Sr.prototype.onRemove=function(){var e=this;br.prototype.onRemove.call(this);var n=this.map||this.getMap();return n&&(Mr.forEach(function(t){n.off(t,e._identifyBaseObjectEvents,e)}),n.off("zooming zoomend",this._zoomend,this)),this},Sr.prototype._callbackBaseObjectAnimation=function(){if(this._animationBaseObjectMap)for(var t in this._animationBaseObjectMap)this._animationBaseObjectMap[t]._animation();return this},Sr.prototype._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*_r)},Sr);function Sr(t,e){var n=br.call(this,t,e)||this;return n._animationBaseObjectMap={},n._needsUpdate=!0,n._mousemoveTimeOut=0,n._baseObjects=[],n._delayMeshes=[],n.type="ThreeLayer",n}Or.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});var jr,Ar=(i(Cr,jr=$.renderer.CanvasLayerRenderer),Cr.prototype.getPrepareParams=function(){return[this.scene,this.camera]},Cr.prototype.getDrawParams=function(){return[this.scene,this.camera]},Cr.prototype._drawLayer=function(){jr.prototype._drawLayer.apply(this,arguments)},Cr.prototype.hitDetect=function(){return!1},Cr.prototype.createCanvas=function(){jr.prototype.createCanvas.call(this),this.createContext()},Cr.prototype.createContext=function(){var t;this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():((t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1}).preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)),this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},Cr.prototype._initThreeRenderer=function(){this.matrix4=new tt.Matrix4;var t=new tt.WebGLRenderer({context:this.gl,alpha:!0,antialias:!0});t.autoClear=!1,t.setClearColor(new tt.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;var e=this.scene=new tt.Scene,n=this.layer.getMap(),r=n.getFov()*Math.PI/180,i=this.camera=new tt.PerspectiveCamera(r,n.width/n.height,n.cameraNear,n.cameraFar);i.matrixAutoUpdate=!1,this._syncCamera(),e.add(i),this.pick=new nr(this.layer)},Cr.prototype.onCanvasCreate=function(){jr.prototype.onCanvasCreate.call(this)},Cr.prototype.resizeCanvas=function(t){var e,n,r,i;this.canvas&&(e=this.getMap(),n=t||e.getSize(),r=e.getDevicePixelRatio?e.getDevicePixelRatio():$.Browser.retina?2:1,(i=this.canvas).height=r*n.height,i.width=r*n.width,this.layer._canvas&&i.style&&(i.style.width=n.width+"px",i.style.height=n.height+"px"),this.context.setSize(i.width,i.height))},Cr.prototype.clearCanvas=function(){this.canvas&&this.context.clear()},Cr.prototype.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},Cr.prototype.renderScene=function(){var t=$.Util.now();16<=t-this._renderTime&&(this.layer._callbackBaseObjectAnimation(),this._renderTime=t),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},Cr.prototype.remove=function(){delete this._drawContext,jr.prototype.remove.call(this)},Cr.prototype._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements},Cr.prototype._createGLContext=function(t,e){for(var n=["webgl2","webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r},Cr);function Cr(){var t=null!==jr&&jr.apply(this,arguments)||this;return t._renderTime=0,t}function Tr(t){return t.getGLZoom()}Or.registerRenderer("gl",Ar),$.registerWorkerAdapter&&$.registerWorkerAdapter("__maptalks.three__",'function(e){"use strict";var d=n,t=n;function n(e,t,n){n=n||2;var r,i,o,a,v,h=t&&t.length,l=h?t[0]*n:e.length,u=p(e,0,l,n,!0),x=[];if(!u||u.next===u.prev)return x;if(h&&(u=function(e,t,n,r){var i,o,a,v,h=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,v=i<o-1?t[i+1]*r:e.length,(v=p(e,a,v,r,!1))===v.next&&(v.steiner=!0),h.push(function(e){var t=e,n=e;for(;(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next,t!==e;);return n}(v));for(h.sort(m),i=0;i<h.length;i++)!function(e,t){(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var v=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(v<=i&&a<v){if((a=v)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}}while(r=r.next,r!==t);if(!n)return null;if(i===a)return n;var h,l=n,u=n.x,x=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=u&&i!==r.x&&b(o<x?i:a,o,u,x,o<x?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),Z(r,e)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&function(e,t){return w(e.prev,e,t.prev)<0&&w(t.next,e,e.next)<0}(n,r)))&&(n=r,f=h)),r=r.next,r!==l;);return n}(e,t))&&(e=S(t,e),g(t,t.next),g(e,e.next))}(h[i],n),n=g(n,n.next);return n}(e,t,u,n)),e.length>80*n){for(var f=r=e[0],s=i=e[1],c=n;c<l;c+=n)(o=e[c])<f&&(f=o),(a=e[c+1])<s&&(s=a),r<o&&(r=o),i<a&&(i=a);v=0!==(v=Math.max(r-f,i-s))?1/v:0}return y(u,x,n,f,s,v),x}function p(e,t,n,r,i){var o,a;if(i===0<z(e,t,n,r))for(o=t;o<n;o+=r)a=v(o,e[o],e[o+1],a);else for(o=n-r;t<=o;o-=r)a=v(o,e[o],e[o+1],a);return a&&u(a,a.next)&&(f(a),a=a.next),a}function g(e,t){if(!e)return e;t=t||e;var n,r=e;do{if(n=!1,r.steiner||!u(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(f(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function y(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){for(var i=e;null===i.z&&(i.z=M(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==e;);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,v,h,l=1;do{for(n=e,o=e=null,a=0;n;){for(a++,r=n,t=v=0;t<l&&(v++,r=r.nextZ);t++);for(h=l;0<v||0<h&&r;)0!==v&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,v--):(r=(i=r).nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}}while(o.nextZ=null,l*=2,1<a)}(i)}(e,r,i,o);for(var v,h,l=e;e.prev!==e.next;)if(v=e.prev,h=e.next,o?function(e,t,n,r){var i=e.prev,o=e,a=e.next;if(0<=w(i,o,a))return!1;var v=(i.x<o.x?i.x<a.x?i:a:o.x<a.x?o:a).x,h=(i.y<o.y?i.y<a.y?i:a:o.y<a.y?o:a).y,l=(i.x>o.x?i.x>a.x?i:a:o.x>a.x?o:a).x,u=(i.y>o.y?i.y>a.y?i:a:o.y>a.y?o:a).y,x=M(v,h,t,n,r),f=M(l,u,t,n,r),s=e.prevZ,c=e.nextZ;for(;s&&s.z>=x&&c&&c.z<=f;){if(s!==e.prev&&s!==e.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;if(s=s.prevZ,c!==e.prev&&c!==e.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}for(;s&&s.z>=x;){if(s!==e.prev&&s!==e.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;s=s.prevZ}for(;c&&c.z<=f;){if(c!==e.prev&&c!==e.next&&b(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}return!0}(e,r,i,o):function(e){var t=e.prev,n=e,r=e.next;if(0<=w(t,n,r))return!1;var i=e.next.next;for(;i!==e.prev;){if(b(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=w(i.prev,i,i.next))return!1;i=i.next}return!0}(e))t.push(v.i/n),t.push(e.i/n),t.push(h.i/n),f(e),e=h.next,l=h.next;else if((e=h)===l){a?1===a?y(e=function(e,t,n){var r=e;do{var i=r.prev,o=r.next.next}while(!u(i,o)&&x(i,r,r.next,o)&&Z(i,o)&&Z(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),f(r),f(r.next),r=e=o),r=r.next,r!==e);return g(r)}(g(e),t,n),t,n,r,i,o,2):2===a&&function(e,t,n,r,i,o){var a=e;do{for(var v=a.next.next;v!==a.prev;){if(a.i!==v.i&&function(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&x(n,n.next,e,t))return!0}while(n=n.next,n!==e);return!1}(e,t)&&(Z(e,t)&&Z(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==e;);return r}(e,t)&&(w(e.prev,e,t.prev)||w(e,t.prev,t))||u(e,t)&&0<w(e.prev,e,e.next)&&0<w(t.prev,t,t.next))}(a,v)){var h=S(a,v);return a=g(a,a.next),h=g(h,h.next),y(a,t,n,r,i,o),y(h,t,n,r,i,o)}v=v.next}}while((a=a.next)!==e)}(e,t,n,r,i,o):y(g(e),t,n,r,i,o,1);break}}}function m(e,t){return e.x-t.x}function M(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function b(e,t,n,r,i,o,a,v){return 0<=(i-a)*(t-v)-(e-a)*(o-v)&&0<=(e-a)*(r-v)-(n-a)*(t-v)&&0<=(n-a)*(o-v)-(i-a)*(r-v)}function w(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function u(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,n,r){var i=l(w(e,t,n)),o=l(w(e,t,r)),a=l(w(n,r,e)),v=l(w(n,r,t));return i!==o&&a!==v||(0===i&&h(e,n,t)||(0===o&&h(e,r,t)||(0===a&&h(n,e,r)||!(0!==v||!h(n,t,r)))))}function h(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function l(e){return 0<e?1:e<0?-1:0}function Z(e,t){return w(e.prev,e,e.next)<0?0<=w(e,t,e.next)&&0<=w(e,e.prev,t):w(e,t,e.prev)<0||w(e,e.next,t)<0}function S(e,t){var n=new a(e.i,e.x,e.y),r=new a(t.i,t.x,t.y),i=e.next,o=t.prev;return(e.next=t).prev=e,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function v(e,t,n,r){n=new a(e,t,n);return r?(n.next=r.next,(n.prev=r).next.prev=n,r.next=n):(n.prev=n).next=n,n}function f(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function a(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function z(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function r(e,t){var n=e.length-1,r=[e[0]];return function e(t,n,r,i,o){for(var a,v,h,l,u,x,f,s=i,c=n+1;c<r;c++){var p=(v=t[c],h=t[n],l=t[r],p=f=x=u=void 0,u=h[0],x=h[1],f=l[0]-u,p=l[1]-x,0===f&&0===p||(1<(h=((v[0]-u)*f+(v[1]-x)*p)/(f*f+p*p))?(u=l[0],x=l[1]):0<h&&(u+=f*h,x+=p*h)),(f=v[0]-u)*f+(p=v[1]-x)*p);s<p&&(a=c,s=p)}i<s&&(1<a-n&&e(t,n,a,i,o),o.push(t[a]),1<r-a&&e(t,a,r,i,o))}(e,0,n,t,r),r.push(e[n]),r}function A(e,t,n){if(e.length<=2)return e;t=void 0!==t?t*t:1;return e=r(e=n?e:function(e,t){for(var n,r,i,o,a=e[0],v=[a],h=1,l=e.length;h<l;h++)n=e[h],i=a,o=void 0,o=(r=n)[0]-i[0],i=r[1]-i[1],t<o*o+i*i&&(v.push(n),a=n);return a!==n&&v.push(n),v}(e,t),t)}function R(e,t){var n=t[0],r=t[1],t=Math.sqrt(n*n+r*r);return e[0]=n/t,e[1]=r/t,e}function s(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function F(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}n.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(z(e,0,o,n));if(i)for(var v=0,h=t.length;v<h;v++){var l=t[v]*n,u=v<h-1?t[v+1]*n:e.length;a-=Math.abs(z(e,l,u,n))}for(var x=0,v=0;v<r.length;v+=3){var f=r[v]*n,s=r[v+1]*n,c=r[v+2]*n;x+=Math.abs((e[f]-e[c])*(e[1+s]-e[1+f])-(e[f]-e[s])*(e[1+c]-e[1+f]))}return 0===a&&0===x?0:Math.abs((x-a)/a)},n.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);0<i&&(r+=e[i-1].length,n.holes.push(r))}return n},d.default=t;var c=[];function ee(e,t,n,r){var i,o,a=(o=n,(i=t)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),v=Math.acos(a)*r;return s(c,n,t,-a),r=(o=i=c)[0],n=o[1],a=o[2],o=Math.sqrt(r*r+n*n+a*a),i[0]=r/o,i[1]=n/o,i[2]=a/o,a=e,o=t,t=Math.cos(v),a[0]=o[0]*t,a[1]=o[1]*t,a[2]=o[2]*t,s(e,e,c,Math.sin(v)),e}function q(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),o=2*t;o<2*n;){var a=e[i],v=e[i+1],h=e[o],l=e[o+1],i=o;o+=2,r+=a*l-h*v}return r}var B=[],U=[],L=[];function O(e,t,n,r,i,o,a,v){var h=null!=a,l=i,u=null;h&&(u=new Uint32Array(r-n));for(var x=n;x<r;x++){var f=x===r-1?n:x+1,s=x===n?r-1:x-1,c=e[2*s],p=e[2*s+1],g=e[2*x],d=e[2*x+1],s=e[2*f],f=e[2*f+1];B[0]=g-c,B[1]=d-p,U[0]=s-g,U[1]=f-d,R(B,B),R(U,U),h&&(u[x]=l),v||x!==n?v||x!==r-1?(c=U,p=B,(s=L)[0]=c[0]+p[0],s[1]=c[1]+p[1],f=L[1],L[1]=-L[0],L[0]=f,R(L,L),s=U,p=(c=L)[0]*s[0]+c[1]*s[1],f=Math.sqrt(1-p*p),c=o*Math.min(10,1/f),h&&a<1/f&&o*p<0?(s=g+L[0]*o,p=d+L[1]*o,f=Math.acos(f)/2,f=Math.tan(f)*Math.abs(o),t[2*l]=s+L[1]*f,t[2*l+1]=p-L[0]*f,t[2*++l]=s-L[1]*f,t[2*l+1]=p+L[0]*f):(t[2*l]=g+L[0]*c,t[2*l+1]=d+L[1]*c)):(L[0]=B[1],L[1]=-B[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o):(L[0]=U[1],L[1]=-U[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o),l++}return u}function P(e,t,n,r,i){var o=null!=r?[]:new Float32Array(e.length);if(O(e,o,0,t&&t.length?t[0]:e.length/2,0,n,r,i),t)for(var a=0;a<t.length;a++){var v=t[a];O(e,o,v,t[a+1]||e.length/2,null!=r?o.length/2:v,n,r,i)}return o}function V(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<t;o++){var a=(i+n)*t+o,v=(r-i-1)*t+o,h=e[a];e[a]=e[v],e[v]=h}return e}function W(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothSide=e.smoothSide||!1,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,"number"==typeof e.depth&&(e.bevelSize=Math.min(0<e.bevelSegments?e.bevelSize:0,e.depth/2)),0<e.bevelSize||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t,n,r,i,o=e.boundingRect;e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect&&(t=null==e.fitRect.x?o.x||0:e.fitRect.x,n=null==e.fitRect.y?o.y||0:e.fitRect.y,r=e.fitRect.width,i=e.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),e.scale=[r/o.width,i/o.height],e.translate=[(t-o.x)*e.scale[0],(n-o.y)*e.scale[1]])}function j(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r,i,o,a,v,h,l,u=[],x=[],f=[],s=[],c=[],p=[],g=e.length,d=new Float32Array(t.length),y=0;y<g;){var m=3*e[y++],M=3*e[y++],b=3*e[y++];n(u,t[m],t[1+m],t[2+m]),n(x,t[M],t[1+M],t[2+M]),n(f,t[b],t[1+b],t[2+b]),F(s,u,x),F(c,x,f),r=p,o=c,l=h=v=a=void 0,a=(i=s)[0],v=i[1],h=i[2],l=o[0],i=o[1],o=o[2],r[0]=v*o-h*i,r[1]=h*l-a*o,r[2]=a*i-v*l;for(var w=0;w<3;w++)d[m+w]=d[m+w]+p[w],d[M+w]=d[M+w]+p[w],d[b+w]=d[b+w]+p[w]}for(var Z,S,z,A,R,q=0;q<d.length;)n(p,d[q],d[q+1],d[q+2]),R=A=z=void 0,z=(S=Z=p)[0],A=S[1],R=S[2],S=Math.sqrt(z*z+A*A+R*R),Z[0]=z/S,Z[1]=A/S,Z[2]=R/S,d[q++]=p[0],d[q++]=p[1],d[q++]=p[2];return d}var te=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function k(e,t,n,r,i,o){var a=t.vertices,v=t.topVertices,h=t.depth,t=t.rect,l=r-n,u=o.smoothSide?1:2,x=l*u,f=o.smoothBevel?1:2,s=Math.min(h/2,o.bevelSize),c=o.bevelSegments,p=i.vertex,g=Math.max(t.width,t.height,h);if(0<s)for(var d=[0,0,1],y=[],m=[0,0,-1],M=[],b=0,w=new Float32Array(l),Z=0;Z<2;Z++)for(var S=0===Z?h-s:s,z=0;z<=c*f;z++){for(var A=0,R=void 0,q=void 0,F=0;F<l;F++){for(var B=0;B<u;B++){var U=2*((F+B)%l+n);y[0]=a[U]-v[U],y[1]=a[1+U]-v[1+U],y[2]=0;var L=Math.sqrt(y[0]*y[0]+y[1]*y[1]);y[0]/=L,y[1]/=L;var O=(Math.floor(z/f)+z%f)/c;0===Z?ee(M,d,y,O):ee(M,y,m,O);var P=0===Z?O:1-O,V=s*Math.sin(P*Math.PI/2),W=L*Math.cos(P*Math.PI/2),O=s*L/Math.sqrt(V*V+W*W),P=M[0]*O+v[U],L=M[1]*O+v[1+U],V=M[2]*O+S;e.position[3*i.vertex]=P,e.position[3*i.vertex+1]=L,e.position[3*i.vertex+2]=V,(0<F||0<B)&&(A+=Math.sqrt((R-P)*(R-P)+(q-L)*(q-L))),(0<z||0<Z)&&(W=3*(i.vertex-x),U=e.position[W],O=e.position[1+W],W=e.position[2+W],w[F]+=Math.sqrt((U-P)*(U-P)+(O-L)*(O-L)+(W-V)*(W-V))),e.uv[2*i.vertex]=A/g,e.uv[2*i.vertex+1]=w[F]/g,R=P,q=L,i.vertex++}if(1<f&&z%f||1==f&&1<=z)for(var j=0;j<6;j++){var k=(te[j][0]+F*u)%x,I=te[j][1]+b;e.indices[i.index++]=(I-1)*x+k+p}}b++}else for(var _=0;_<2;_++)for(var D=0===_?h-s:s,E=0,C=void 0,G=void 0,H=0;H<l;H++)for(var J=0;J<u;J++){var K=2*((H+J)%l+n),N=a[K],K=a[1+K];e.position[3*i.vertex]=N,e.position[3*i.vertex+1]=K,e.position[3*i.vertex+2]=D,(0<H||0<J)&&(E+=Math.sqrt((C-N)*(C-N)+(G-K)*(G-K))),e.uv[2*i.vertex]=E/g,e.uv[2*i.vertex+1]=D/g,C=N,G=K,i.vertex++}for(var Q=0<s?c*f+1:1,T=0;T<l;T++)for(var X=0;X<6;X++){var Y=(te[X][0]+T*u)%x,$=te[X][1]+Q;e.indices[i.index++]=($-1)*x+Y+p}}function I(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var o=e[i],a=o.indices,v=o.vertices,h=o.holes,o=o.depth,l=v.length/2,u=0<Math.min(o/2,t.bevelSize)?t.bevelSegments:0;n+=a.length*(t.excludeBottom?1:2),r+=l*(t.excludeBottom?1:2);for(var x=2+2*u,f=0,s=0,c=0;c<(h?h.length:0)+1;c++){n+=6*((s=0===c?h&&h.length?h[0]:l:(f=h[c-1],h[c]||l))-f)*(x-1);var p=(s-f)*(t.smoothSide?1:2);r+=p*x+(t.smoothBevel?0:u*p*2)}}for(var g={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},d={vertex:0,index:0},y=0;y<e.length;y++)!function(e,t,n,r){var i=e.indices,o=e.vertices,a=e.topVertices,v=e.rect,h=e.depth;if(!(o.length<=4)){for(var l=n.vertex,u=i.length,x=0;x<u;x++)t.indices[n.index++]=l+i[x];for(var f=Math.max(v.width,v.height),s=0;s<(r.excludeBottom?1:2);s++)for(var c=0;c<a.length;c+=2){var p=a[c],g=a[c+1];t.position[3*n.vertex]=p,t.position[3*n.vertex+1]=g,t.position[3*n.vertex+2]=(1-s)*h,t.uv[2*n.vertex]=(p-v.x)/f,t.uv[2*n.vertex+1]=(g-v.y)/f,n.vertex++}if(!r.excludeBottom)for(var d=o.length/2,y=0;y<u;y+=3)for(var m=0;m<3;m++)t.indices[n.index++]=l+d+i[y+2-m]}}(e[y],g,d,t);for(var m=0;m<e.length;m++){var M,b=e[m],w=b.holes,Z=b.vertices.length/2,S=w&&w.length?w[0]:Z;if(k(g,e[m],0,S,d,t),w)for(var z=0;z<w.length;z++)M=w[z],S=w[z+1]||Z,k(g,e[m],M,S,d,t)}for(var A=0;A<g.uv.length;A++){var R=g.uv[A];0<R&&Math.round(R)===R?g.uv[A]=1:g.uv[A]=R%1}return g.normal=j(g.indices,g.position),g.boundingRect=e[0]&&e[0].rect,g}function _(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)E(e[i][0],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);for(var o=[],a=t.translate||[0,0],v=t.scale||[1,1],h=t.boundingRect,l={x:h.x*v[0]+a[0],y:h.y*v[1]+a[1],width:h.width*v[0],height:h.height*v[1]},u=Math.min(h.width,h.height)/1e5,x=0;x<e.length;x++){var f=function(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],o=[],a=i.length,v=i[a-1][0],h=i[a-1][1],l=0,u=0;u<a;u++){var x=i[u][0],f=i[u][1],s=x-v,c=f-h;t<(l+=Math.sqrt(s*s+c*c))&&(o.push(i[u]),l=0),v=x,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(e[x],u);if(f){var s=t.simplify/Math.max(v[0],v[1]);if(f=0<s?function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];3<=(i=A(i,t,!0)).length&&n.push(i)}return 0<n.length?n:null}(f,s):f){for(var c=d.flatten(f),p=c.vertices,s=c.holes,f=c.dimensions,g=0;g<p.length;)p[g]=p[g++]*v[0]+a[0],p[g]=p[g++]*v[1]+a[1];if(!function(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;0<q(e,r,i)&&V(e,2,r,i);for(var o=1;o<(t?t.length:0)+1;o++)q(e,r=t[o-1],i=t[o]||n)<0&&V(e,2,r,i)}(p,s),2!==f)throw new Error("Only 2D polygon points are supported");c=0<t.bevelSize?P(p,s,t.bevelSize,null,!0):p,f=d(c,s,f=void 0===(f=f)?2:f);o.push({indices:f,vertices:p,topVertices:c,holes:s,rect:l,depth:"function"==typeof t.depth?t.depth(x):t.depth})}}}return I(o,t)}function D(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)E(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);var o=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var a=[],v=0;v<e.length;v++){var h=e[v],l=t.simplify/Math.max(o[0],o[1]);0<l&&(h=A(h,l,!0)),a.push(function(e,t,n){for(var r=n.lineWidth,i=e.length,o=new Float32Array(2*i),a=n.translate||[0,0],v=n.scale||[1,1],h=0,l=0;h<i;h++)o[l++]=e[h][0]*v[0]+a[0],o[l++]=e[h][1]*v[1]+a[1];q(o,0,i)<0&&V(o,2,0,i);var u=[],x=[],f=n.miterLimit,s=O(o,x,0,i,0,-r/2,f,!1);V(o,2,0,i);for(var c=O(o,u,0,i,0,-r/2,f,!1),r=(u.length+x.length)/2,p=new Float32Array(2*r),g=0,d=x.length/2,y=0;y<x.length;y++)p[g++]=x[y];for(var m=0;m<u.length;m++)p[g++]=u[m];for(var M=new(65535<r?Uint32Array:Uint16Array)(3*(2*(i-1)+(r-2*i))),b=0,w=0;w<i-1;w++){var Z=w+1;M[b++]=d-1-s[w],M[b++]=d-1-s[w]-1,M[b++]=c[w]+1+d,M[b++]=d-1-s[w],M[b++]=c[w]+1+d,M[b++]=c[w]+d,c[Z]-c[w]==2?(M[b++]=c[w]+2+d,M[b++]=c[w]+1+d,M[b++]=d-s[Z]-1):s[Z]-s[w]==2&&(M[b++]=c[Z]+d,M[b++]=d-1-(s[w]+1),M[b++]=d-1-(s[w]+2))}return f=0<n.bevelSize?P(p,[],n.bevelSize,null,!0):p,r=n.boundingRect,{vertices:p,indices:M,topVertices:f,rect:{x:r.x*v[0]+a[0],y:r.y*v[1]+a[1],width:r.width*v[0],height:r.height*v[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}(h,v,t))}return I(a,t)}function E(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}function C(e){for(var t=new Float32Array(e),n=[],r=0,i=t.length;r<i;r+=2){var o=t[r],a=t[r+1];n.push([o,a])}return n}function G(e,t){void 0===t&&(t=!1);for(var n,r,i=e.length,o=[],a=[],v=[],h=0,l=0,u=0,x=0,f=0;f<i;f++){var s=t?(n=e[f],s=r=void 0,r=n.data,s=n.height,n=n.width,D(r,{lineWidth:n,depth:s})):(c=e[f],d=g=p=d=g=p=void 0,p=c.data,g=c.height,d=_(p,{depth:g}),c=d.position,p=d.normal,g=d.uv,d=d.indices,{position:c,normal:p,uv:g,indices:d}),c=s.position,p=s.normal,g=s.uv,d=s.indices;a.push(s);d=d.length/3;v[f]=[h+1,h+d],h+=d;c=c.length/3,p=p.length/3,g=g.length/2;o[f]={position:{count:c,start:l,end:l+3*c},normal:{count:p,start:u,end:u+3*p},uv:{count:g,start:x,end:x+2*g},hide:!1},l+=3*c,u+=3*p,x+=2*g}var y=function(e){for(var t={},n={},r=0;r<e.length;++r){var i,o=e[r];for(i in o)void 0===t[i]&&(t[i]=[],n[i]=0),t[i].push(o[i]),n[i]+=o[i].length}var a,v={},h=0,l=[];for(a in t)if("indices"===a)for(var u=t[a],x=0,f=u.length;x<f;x++){for(var s=u[x],c=0,p=s.length;c<p;c++)l.push(s[c]+h);h+=t.position[x].length/3}else{var g=function(e,t){for(var n=new Float32Array(t),r=0,i=0;i<e.length;++i)n.set(e[i],r),r+=e[i].length;return n}(t[a],n[a]);if(!g)return null;v[a]=g}return v.indices=new Uint32Array(l),v}(a),m=y.position,M=y.normal,b=y.uv,y=y.indices;return{position:m.buffer,normal:M.buffer,uv:b.buffer,indices:y.buffer,faceMap:v,geometriesAttributes:o}}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,e=n.type,r=n.datas;if("Polygon"===e){!function(e){for(var t=e.length,n=0;n<t;n++)for(var r=e[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],v=0,h=a.length;v<h;v++)e[n].data[i][v]=C(a[v])}(r);n=G(r);t(null,n,[n.position,n.normal,n.uv,n.indices])}else if("LineString"===e){for(var i=0,o=r.length;i<o;i++)for(var a=0,v=r[i].data.length;a<v;a++)r[i].data[a]=C(r[i].data[a]);e=G(r,!0);t(null,e,[e.position,e.normal,e.uv,e.indices])}},Object.defineProperty(e,"__esModule",{value:!0})}'),t.BaseObject=y,t.ExtrudeUtil=ae,t.GeoJSONUtil=Gt,t.GeoUtil=Se,t.IdentifyUtil=Ke,t.LineMaterial=v,t.LineUtil=Nt,t.MergeGeometryUtil=m,t.MergedMixin=Pe,t.ThreeLayer=Or,t.ThreeRenderer=Ar,t.geometryExtrude=Lt,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.15.2, requires maptalks@>=0.39.0.")});